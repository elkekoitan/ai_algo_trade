<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d1117"> <!-- Dark theme primary -->
    <title>Pro Grid Trading Calculator Enhanced</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Light Theme (Default) */
            --bg-color: #f4f7f9;
            --surface-color: #ffffff;
            --surface-alt-color: #f8f9fa;
            --text-color: #2c3e50;
            --text-muted-color: #7f8c8d;
            --primary-color: #3498db; /* Blue */
            --primary-dark-color: #2980b9;
            --accent-color: #e67e22; /* Orange */
            --success-color: #2ecc71; /* Green */
            --danger-color: #e74c3c; /* Red */
            --warning-color: #f39c12; /* Yellow for warnings */
            --info-color: #3498db; /* Blue for info */
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.3);
            --scrollbar-thumb-color: #bdc3c7;
            --scrollbar-track-color: #ecf0f1;

            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --spacing-unit: 8px;
        }

        html[data-theme="dark"] {
            --bg-color: #0d1117; 
            --surface-color: #161b22; 
            --surface-alt-color: #0f131a;
            --text-color: #c9d1d9; 
            --text-muted-color: #8b949e;
            --primary-color: #58a6ff; 
            --primary-dark-color: #388bfd;
            --accent-color: #f18805; 
            --success-color: #3fb950;
            --danger-color: #f85149;
            --warning-color: #f7b731;
            --info-color: #58a6ff;
            --border-color: #30363d; 
            --shadow-color: rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(22, 27, 34, 0.6); 
            --glass-border: rgba(48, 54, 61, 0.5);
            --scrollbar-thumb-color: #586069;
            --scrollbar-track-color: #22272e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent; 
        }

        html, body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overscroll-behavior-y: contain;
            font-size: 14px; 
        }
        
        @media (min-width: 768px) {
            html, body {
                font-size: 15px; 
            }
        }
        @media (min-width: 1200px) {
            html, body {
                font-size: 16px; 
            }
        }


        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .app-bar {
            background: linear-gradient(135deg, var(--primary-dark-color) 0%, var(--primary-color) 100%);
            color: #fff;
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-bar h1 {
            font-size: 1.5em;
            margin: 0;
            font-weight: 600;
        }
        .theme-toggle-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: var(--spacing-unit);
        }

        .tab-navigation {
            display: flex;
            background-color: var(--surface-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 60px; 
            z-index: 990;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-navigation::-webkit-scrollbar { display: none; }

        .tab-button {
            flex-grow: 1;
            padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
            background-color: transparent;
            color: var(--text-muted-color);
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 0.95em;
            text-align: center;
            cursor: pointer;
            transition: color 0.3s, border-bottom-color 0.3s;
            white-space: nowrap;
            font-weight: 500;
        }
        .tab-button:hover {
            color: var(--primary-color);
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .content-area {
            flex-grow: 1;
            padding: var(--spacing-unit);
            overflow-y: auto;
        }
        @media (min-width: 768px) {
            .content-area { padding: calc(var(--spacing-unit) * 2); }
        }


        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: calc(var(--spacing-unit) * 2);
            padding: calc(var(--spacing-unit) * 2);
            border: 1px solid var(--border-color);
        }
        .card.glass {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            padding-bottom: var(--spacing-unit);
            border-bottom: 1px solid var(--border-color);
        }

        .form-group { margin-bottom: calc(var(--spacing-unit) * 1.8); }
        .form-group label {
            display: block;
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: var(--spacing-unit);
            color: var(--text-muted-color);
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: calc(var(--spacing-unit) * 1.2);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 1em;
            background-color: var(--surface-alt-color);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 30%, transparent);
        }
        .form-group input[type="number"] { -moz-appearance: textfield; }
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .form-group input[type="checkbox"] {
            margin-right: var(--spacing-unit);
            vertical-align: middle;
            transform: scale(1.3); accent-color: var(--primary-color);
        }
        .form-group .checkbox-label { font-size: 0.95em; vertical-align: middle; color: var(--text-color); }
        
        .input-group { display: flex; gap: var(--spacing-unit); align-items: flex-end; }
        .input-group .form-group { flex: 1; margin-bottom: 0; }
        .dual-input-group { display: flex; align-items: center; gap: var(--spacing-unit); }
        .dual-input-group input[type="range"] { flex-grow: 1; }
        .dual-input-group input[type="number"] { width: 80px; flex-grow: 0; text-align: center;}


        .action-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-unit);
            padding: calc(var(--spacing-unit) * 1.5);
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            position: sticky; bottom: 0; z-index: 1000;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }
        .btn {
            padding: calc(var(--spacing-unit) * 1.2) calc(var(--spacing-unit) * 1.5);
            font-size: 0.95em; font-weight: 600;
            border-radius: var(--border-radius-md); border: none;
            cursor: pointer; transition: all 0.2s ease-in-out;
            text-align: center; display: flex; align-items: center; justify-content: center; gap: var(--spacing-unit);
        }
        .btn svg { width: 1em; height: 1em; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background-color: var(--primary-dark-color); transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); }
        .btn-secondary { background-color: var(--surface-alt-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: color-mix(in srgb, var(--border-color) 40%, transparent); transform: translateY(-2px); }

        /* Range Slider Styling */
        .range-slider-group { margin-bottom: calc(var(--spacing-unit) * 2); }
        .range-slider-group label { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: var(--spacing-unit); color: var(--text-muted-color); }
        .range-slider-group label span:last-child { font-weight: 600; color: var(--primary-color); }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px;
            background: var(--border-color);
            outline: none; border-radius: var(--border-radius-sm);
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: var(--primary-color);
            border-radius: 50%; cursor: pointer;
            border: 3px solid var(--surface-color);
            box-shadow: 0 0 5px var(--shadow-color);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px; 
            background: var(--primary-color);
            border-radius: 50%; cursor: pointer;
            border: 3px solid var(--surface-color);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        /* Grid Seviyeleri Tab Specific Styles */
        #grid-levels-container-wrapper, #manual-grid-levels-container-wrapper {
            max-height: calc(100vh - 350px); 
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
        }
        .level-table { width: 100%; border-collapse: collapse; }
        .level-table th, .level-table td {
            padding: var(--spacing-unit);
            text-align: center;
            font-size: 0.85em;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .level-table th {
            background-color: var(--surface-alt-color);
            color: var(--primary-color);
            position: sticky; top: 0; z-index: 10;
            font-weight: 600;
        }
        .level-table td input[type="checkbox"] { display: block; margin: auto; transform: scale(1.2); }
        .level-table td input[type="number"] {
            width: 100%; min-width: 60px; padding: var(--spacing-unit); font-size: 0.9em;
            text-align: center; border-radius: var(--border-radius-sm);
        }
        .level-table td input[disabled] { background-color: color-mix(in srgb, var(--border-color) 20%, transparent); color: var(--text-muted-color); }
        .level-table .dual-input-controls input[type="number"] { width: 70px !important; min-width: 70px !important;} /* Override for table */
        .level-table .dual-input-controls { min-width: 150px; } /* Ensure enough space for slider+num in table */


        #sonuclar-tab textarea {
            width: 100%; min-height: 300px;
            font-family: "SF Mono", "Consolas", "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.85em; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); padding: var(--spacing-unit);
            background-color: var(--surface-alt-color); white-space: pre; color: var(--text-color);
        }

        .collapsible-header {
            background-color: var(--surface-alt-color);
            padding: calc(var(--spacing-unit) * 1.2) calc(var(--spacing-unit) * 1.5);
            cursor: pointer; border-radius: var(--border-radius-md); margin-top: var(--spacing-unit);
            font-weight: 500; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .collapsible-header:hover { background-color: color-mix(in srgb, var(--border-color) 20%, transparent); }
        .collapsible-header::after { content: '▼'; font-size: 0.8em; transition: transform 0.2s ease-in-out; }
        .collapsible-header.active::after { transform: rotate(180deg); }
        .collapsible-content {
            padding: calc(var(--spacing-unit) * 1.5); display: none;
            border: 1px solid var(--border-color); border-top: none;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            background-color: var(--surface-color);
        }
        .collapsible-content.active { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 1000px; /* Increased max-height */ } }
        
        .quick-presets-container { display: flex; flex-wrap: wrap; gap: var(--spacing-unit); margin-bottom: var(--spacing-unit); }
        .quick-presets-container .btn { font-size: 0.85em; padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.2); }

        /* Time Input Styling */
        .time-input-container { display: flex; align-items: center; gap: calc(var(--spacing-unit) / 2); }
        .time-input-container input[type="number"] { flex: 1; min-width: 50px; text-align: center; }
        .time-input-container span.time-separator { font-weight: bold; padding: 0 calc(var(--spacing-unit) / 2); }
        
        /* Risk Meter & Margin Gauge Styling */
        .gauge-container { text-align: center; margin-bottom: var(--spacing-unit); flex:1; }
        .gauge-wrapper {
            position: relative;
            width: 120px; height: 60px; /* Half circle */
            margin: auto;
            overflow: hidden; /* To clip the bottom half */
        }
        .gauge-bg, .gauge-fill, .gauge-cover {
            position: absolute;
            top: 0; left: 0;
            width: 120px; height: 120px; /* Full circle */
            border-radius: 50%;
        }
        .gauge-bg { background-color: var(--border-color); }
        .gauge-fill {
            background-color: var(--success-color);
            clip-path: polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%); /* Right half */
            transform-origin: 50% 50%;
            transition: transform 0.5s ease-out;
        }
        .gauge-cover {
            background-color: var(--surface-color);
            width: 100px; height: 100px; /* Inner circle */
            top: 10px; left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 600;
            text-align: center;
        }
        .gauge-label { font-size: 0.8em; color: var(--text-muted-color); margin-top: var(--spacing-unit); }


        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track-color); border-radius: var(--border-radius-sm); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-color); border-radius: var(--border-radius-sm); }
        ::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--scrollbar-thumb-color) 80%, black); }

        /* Chart placeholder */
        .chart-container {
            width: 100%;
            min-height: 250px; 
            max-height: 350px;
            background-color: var(--surface-alt-color);
            border: 1px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            color: var(--text-muted-color);
            margin-top: var(--spacing-unit);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }


        /* Toast Notification Styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 12px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-left: 5px solid var(--primary-color);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }
        .toast-icon { font-size: 1.5em; }
        .toast-message { flex-grow: 1; }
        .toast-close { background:none; border:none; color:var(--text-muted-color); font-size:1.2em; cursor:pointer; }

        /* Loading Spinner */
        .loader-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .loader {
            border: 8px solid var(--surface-alt-color);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Preset Management */
        #preset-management-tab .preset-slot, .modal-preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            margin-bottom: 8px;
            background-color: var(--surface-alt-color);
            cursor: pointer;
        }
        #preset-management-tab .preset-slot:hover, .modal-preset-item:hover {
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        #preset-management-tab .preset-name, .modal-preset-item .preset-name {
            flex-grow: 1;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        #preset-management-tab .preset-actions button {
            margin-left: 5px;
            padding: 5px 8px;
            font-size: 0.8em;
        }
        #preset-list-container, #modal-preset-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
         .form-group.dual-input {
            display: flex;
            flex-direction: column; /* Label above */
        }
        .dual-input-controls {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between slider and number input */
        }
        .dual-input-controls input[type="range"] {
            flex-grow: 1; /* Slider takes available space */
        }
        .dual-input-controls input[type="number"] {
            width: 80px; /* Fixed width for number input */
            flex-shrink: 0; /* Prevent shrinking */
            text-align: center;
        }

        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 10001;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px var(--shadow-color);
            position: relative;
        }
        .modal-close-btn {
            color: var(--text-muted-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close-btn:hover, .modal-close-btn:focus {
            color: var(--text-color);
            text-decoration: none;
        }
        .modal-title {
            font-size: 1.3em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #fibo-levels-display {
            font-size: 0.85em;
            color: var(--text-muted-color);
            margin-top: 5px;
            padding: 8px;
            background-color: var(--surface-alt-color);
            border-radius: var(--border-radius-sm);
            border: 1px dashed var(--border-color);
        }

    </style>
</head>
<body>
    <div id="app">
        <header class="app-bar">
            <h1>Pro Grid Calculator</h1>
            <button id="theme-toggle-btn" class="theme-toggle-btn" aria-label="Toggle Theme">☀️</button>
        </header>

        <nav class="tab-navigation">
            <button data-tab="temel-ayarlar-tab" class="tab-button active">Temel</button>
            <button data-tab="grid-manual-seviyeler-tab" class="tab-button">Grid Seviyeleri</button>
            <button data-tab="ea-ayarlari-tab" class="tab-button">EA Ayarları</button>
            <button data-tab="analiz-simulasyon-tab" class="tab-button">Analiz</button>
            <button data-tab="preset-management-tab" class="tab-button">Presetler</button>
            <button data-tab="sonuclar-tab" class="tab-button">Sonuçlar</button>
        </nav>

        <main class="content-area">
            <!-- Temel Ayarlar Sekmesi -->
            <section id="temel-ayarlar-tab" class="tab-content active">
                <div class="card glass">
                    <h2 class="card-title">Genel Ayarlar</h2>
                    <div class="form-group">
                        <label for="instrument">Enstrüman:</label>
                        <select id="instrument"> </select>
                    </div>
                    <div class="form-group">
                        <label>Hızlı Ayar Setleri:</label>
                        <div class="quick-presets-container">
                            <button id="preset-gold" class="btn btn-secondary">🥇 Altın</button>
                            <button id="preset-btc" class="btn btn-secondary">₿ Bitcoin</button>
                            <button id="preset-eurusd" class="btn btn-secondary">€ EURUSD</button>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="finnhub-api-key">Finnhub API Anahtarı (Fibo için):</label>
                        <input type="text" id="finnhub-api-key" placeholder="Finnhub API Anahtarınızı Buraya Girin">
                    </div>
                     <div class="input-group">
                        <div class="form-group">
                            <label for="upper-price-range">Üst Fiyat Aralığı (Grid Dağıtımı İçin):</label>
                            <input type="number" id="upper-price-range" step="any" placeholder="Opsiyonel">
                        </div>
                        <div class="form-group">
                            <label for="lower-price-range">Alt Fiyat Aralığı (Grid Dağıtımı İçin):</label>
                            <input type="number" id="lower-price-range" step="any" placeholder="Opsiyonel">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="timeframe-select">Zaman Aralığı (Fibo için):</label>
                        <select id="timeframe-select">
                            <option value="M1">M1</option><option value="M5">M5</option><option value="M15">M15</option>
                            <option value="M30">M30</option><option value="H1" selected>H1</option><option value="H4">H4</option>
                            <option value="D1">D1</option><option value="W1">W1</option><option value="MN1">MN1</option>
                        </select>
                        <button id="btn-auto-fibo-range" class="btn btn-secondary" style="font-size:0.8em; padding: 5px 8px; margin-top: 5px;">Fibo Aralığı Otomatik Doldur</button>
                        <div id="fibo-levels-display">Fibo seviyeleri burada gösterilecek...</div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="start-price">Başlangıç Fiyatı:</label>
                            <input type="number" id="start-price" step="any">
                        </div>
                        <div class="form-group">
                            <label for="point-decimals">Fiyat Ondalık:</label>
                            <input type="number" id="point-decimals" min="0" max="8">
                        </div>
                    </div>
                     <div class="input-group">
                        <div class="form-group">
                            <label for="tick-size">Tick Büyüklüğü (1 Puan):</label>
                            <input type="number" id="tick-size" step="any">
                        </div>
                        <div class="form-group">
                            <label for="value-per-point">1 Puan Değeri (1 Lot):</label>
                            <input type="number" id="value-per-point" step="any">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="balance">Hesap Bakiyesi:</label>
                            <input type="number" id="balance" step="100">
                        </div>
                        <div class="form-group">
                            <label for="leverage">Kaldıraç (1:X):</label>
                            <input type="number" id="leverage" step="10">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="contract-size">Kontrat Büyüklüğü (1 Lot):</label>
                        <input type="number" id="contract-size" step="1">
                    </div>
                    <div class="range-slider-group">
                        <label for="volatility-input">Piyasa Volatilitesi (Örn. Günlük ATR Puan): <span id="volatility-value-display">1000</span></label>
                        <input type="range" id="volatility-input" min="100" max="50000" step="100" value="1000">
                         <div class="form-group" style="margin-top: 5px;">
                            <input type="checkbox" id="use-atr-for-smart-distance" checked>
                            <label for="use-atr-for-smart-distance" class="checkbox-label">Smart Distance için ATR Kullan</label>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="risk-percent">Risk Yüzdesi (% Bakiye):</label>
                        <input type="number" id="risk-percent" min="0.1" max="100" step="0.1" value="5.0" placeholder="Örn: 5 (Max DD için)">
                    </div>
                </div>
            </section>

            <!-- Grid Seviyeleri Sekmesi (Manuel & Otomatik Entegre) -->
            <section id="grid-manual-seviyeler-tab" class="tab-content">
                <div class="card glass">
                    <h2 class="card-title">Grid Seviye Ayarları</h2>
                    
                    <div class="collapsible-header active" data-collapsible="auto-grid-config">Otomatik Grid Yapılandırma Araçları</div>
                    <div class="collapsible-content active" id="auto-grid-config">
                        <div class="form-group">
                            <label for="grid-level-count">Kademe Sayısı: <span id="grid-level-count-display">14</span></label>
                            <input type="range" id="grid-level-count" min="1" max="50" value="14" step="1">
                        </div>
                        <div class="form-group">
                            <label for="lot-progression-model">Lot Artış Modeli:</label>
                            <select id="lot-progression-model">
                                <option value="linear">Lineer (Eşit Lotlar)</option>
                                <option value="martingale" selected>Martingale (x2)</option>
                                <option value="custom_multiplier">Özel Çarpan</option>
                                <option value="fibonacci_weighted">Fibonacci Ağırlıklı</option>
                                <option value="custom_sequence">Özel Sıra (Manuel Tablodan)</option>
                            </select>
                        </div>
                        <div id="custom-multiplier-group" class="form-group" style="display:none;">
                            <label for="lot-custom-multiplier">Özel Çarpan Değeri: <span id="lot-custom-multiplier-display">1.5</span></label>
                            <input type="range" id="lot-custom-multiplier" min="1.0" max="10.0" step="0.05" value="1.5">
                        </div>
                        <div id="fibo-level-group" class="form-group" style="display:none;">
                            <label for="fibo-strength-level">Fibonacci Etki Seviyesi (Lot Artışı İçin):</label>
                            <select id="fibo-strength-level">
                                <option value="0.236">0.236 (Düşük Etki)</option>
                                <option value="0.382">0.382</option>
                                <option value="0.5">0.5 (Orta Etki)</option>
                                <option value="0.618" selected>0.618 (Altın Oran)</option>
                                <option value="0.786">0.786</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <div class="form-group">
                                <label for="initial-lot">Başlangıç Lot:</label>
                                <input type="number" id="initial-lot" value="0.01" step="0.01" min="0.01">
                            </div>
                            <div class="form-group">
                                <label for="total-lot-target">Hedef Toplam Lot (Opsiyonel):</label>
                                <input type="number" id="total-lot-target" step="0.01" placeholder="Otomatik dağıtım için">
                            </div>
                        </div>
                         <div class="form-group dual-input">
                            <label for="grid-distance-points">Varsayılan Grid Mesafesi (Puan): <span id="grid-distance-points-display">0</span></label>
                            <div class="dual-input-controls">
                                <input type="range" id="grid-distance-points" min="0" max="100000" step="100" value="0">
                                <input type="number" id="grid-distance-points-num" min="0" max="100000" step="100" value="0">
                            </div>
                            <button id="btn-smart-distance" class="btn btn-secondary" style="font-size:0.8em; padding: 5px 8px; margin-top: 5px;">Smart Distance</button>
                        </div>
                        <div class="form-group dual-input">
                            <label for="default-tp-points">Varsayılan TP (Puan): <span id="default-tp-points-display">13000</span></label>
                            <div class="dual-input-controls">
                                <input type="range" id="default-tp-points" min="0" max="200000" step="100" value="13000">
                                <input type="number" id="default-tp-points-num" min="0" max="200000" step="100" value="13000">
                            </div>
                        </div>
                        <div class="form-group dual-input">
                            <label for="default-sl-points">Varsayılan SL (Puan): <span id="default-sl-points-display">1111111111</span></label>
                            <div class="dual-input-controls">
                                <input type="range" id="default-sl-points" min="0" max="2000000000" step="1000" value="1111111111">
                                <input type="number" id="default-sl-points-num" min="0" max="2000000000" step="1000" value="1111111111">
                            </div>
                        </div>
                        <div class="form-group">
                             <label for="max-lot-per-order">Max Lot / Kademe:</label>
                             <input type="number" id="max-lot-per-order" step="0.01" value="10.00" placeholder="Sınırsız için boş bırak">
                        </div>
                         <div class="form-group">
                            <button id="btn-apply-auto-to-manual" class="btn btn-primary">Otomatik Ayarları Manuel Tabloya Uygula</button>
                        </div>
                    </div>
                    
                    <h3 class="card-title" style="margin-top: var(--spacing-unit); font-size:1.1em;">Manuel Kademe Detayları</h3>
                    <div id="manual-grid-levels-container-wrapper">
                        <table class="level-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Aktif?</th>
                                    <th>Lot</th>
                                    <th>Mesafe(P)</th>
                                    <th>TP (P)</th>
                                    <th>SL (P)</th>
                                </tr>
                            </thead>
                            <tbody id="manual-grid-levels-tbody">
                                <!-- Manual Levels will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- EA Ayarları Sekmesi -->
            <section id="ea-ayarlari-tab" class="tab-content">
                <div class="card glass">
                    <h2 class="card-title">MetaTrader EA Parametreleri</h2>
                    <div class="form-group">
                        <label for="ea-position-comment">Pozisyon Yorumu:</label>
                        <input type="text" id="ea-position-comment" value="ProGridCalc_v1">
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="ea-buy-islemi-ac" checked>
                        <label for="ea-buy-islemi-ac" class="checkbox-label">Alış İşlemlerine İzin Ver</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="ea-sell-islemi-ac" checked>
                        <label for="ea-sell-islemi-ac" class="checkbox-label">Satış İşlemlerine İzin Ver</label>
                    </div>

                    <div class="collapsible-header active" data-collapsible="pivot-settings">Pivot Ayarları</div>
                    <div class="collapsible-content active" id="pivot-settings">
                        <div class="form-group">
                            <label for="ea-pivot-ust">Pivot Üst:</label>
                            <input type="number" id="ea-pivot-ust" step="any">
                        </div>
                        <div class="form-group">
                            <label for="ea-pivot-alt">Pivot Alt:</label>
                            <input type="number" id="ea-pivot-alt" step="any">
                        </div>
                    </div>

                    <div class="collapsible-header active" data-collapsible="alert-settings">Uyarı Ayarları</div>
                    <div class="collapsible-content active" id="alert-settings">
                        <div class="form-group">
                            <input type="checkbox" id="ea-alert3" checked> <label for="ea-alert3" class="checkbox-label">3. Kademe Uyarısı</label>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="ea-alert4" checked> <label for="ea-alert4" class="checkbox-label">4. Kademe Uyarısı</label>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="ea-alert5" checked> <label for="ea-alert5" class="checkbox-label">5. Kademe Uyarısı</label>
                        </div>
                    </div>
                    
                    <div class="collapsible-header active" data-collapsible="time-filter-settings">Zaman Filtresi Ayarları</div>
                    <div class="collapsible-content active" id="time-filter-settings">
                        <div class="form-group">
                            <input type="checkbox" id="ea-use-time-limit"> <label for="ea-use-time-limit" class="checkbox-label">Ana Zaman Filtresini Kullan</label>
                        </div>
                        <div class="input-group">
                            <div class="form-group">
                                <label>Başlangıç (Ana):</label>
                                <div class="time-input-container">
                                    <input type="number" id="ea-before-hour" min="0" max="23"> <span class="time-separator">:</span>
                                    <input type="number" id="ea-before-min" min="0" max="59">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Bitiş (Ana):</label>
                                 <div class="time-input-container">
                                    <input type="number" id="ea-after-hour" min="0" max="23"> <span class="time-separator">:</span>
                                    <input type="number" id="ea-after-min" min="0" max="59">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="ea-use-time-limit-break"> <label for="ea-use-time-limit-break" class="checkbox-label">Ara Zaman (Mola) Filtresini Kullan</label>
                        </div>
                        <div class="input-group">
                             <div class="form-group">
                                <label>Başlangıç (Mola):</label>
                                <div class="time-input-container">
                                    <input type="number" id="ea-after-hour-break" min="0" max="23"> <span class="time-separator">:</span>
                                    <input type="number" id="ea-after-min-break" min="0" max="59">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Bitiş (Mola):</label>
                                <div class="time-input-container">
                                    <input type="number" id="ea-before-hour-break" min="0" max="23"> <span class="time-separator">:</span>
                                    <input type="number" id="ea-before-min-break" min="0" max="59">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Analiz & Simülasyon Sekmesi -->
            <section id="analiz-simulasyon-tab" class="tab-content">
                <div class="card glass">
                    <h2 class="card-title">Risk Analizi ve Görselleştirme</h2>
                    <div class="input-group">
                        <div class="gauge-container">
                            <div class="gauge-wrapper">
                                <div class="gauge-bg"></div>
                                <div class="gauge-fill" id="risk-meter-fill"></div>
                                <div class="gauge-cover" id="risk-meter-text">Düşük</div>
                            </div>
                            <div class="gauge-label">Risk Metresi</div>
                        </div>
                        <div class="gauge-container">
                             <div class="gauge-wrapper">
                                <div class="gauge-bg"></div>
                                <div class="gauge-fill" id="margin-usage-fill-buy"></div>
                                <div class="gauge-cover" id="margin-usage-text-buy">%0</div>
                            </div>
                            <div class="gauge-label">Marjin Kullanımı (Alış)</div>
                        </div>
                         <div class="gauge-container">
                             <div class="gauge-wrapper">
                                <div class="gauge-bg"></div>
                                <div class="gauge-fill" id="margin-usage-fill-sell"></div>
                                <div class="gauge-cover" id="margin-usage-text-sell">%0</div>
                            </div>
                            <div class="gauge-label">Marjin Kullanımı (Satış)</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>P&L / Grid Görselleştirme (Batch Kapama Senaryosu)</label>
                        <div class="chart-container">
                             <canvas id="gridPnlChart"></canvas>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Risk Dağılımı (Max DD)</label>
                         <div class="chart-container">
                             <canvas id="riskBreakdownChart"></canvas>
                        </div>
                    </div>
                     <div class="form-group">
                        <label>Hızlı Senaryolar:</label>
                        <div class="quick-presets-container">
                            <button id="scenario-conservative" class="btn btn-secondary">Muhafazakar</button>
                            <button id="scenario-moderate" class="btn btn-secondary">Orta Düzey</button>
                            <button id="scenario-aggressive" class="btn btn-secondary">Agresif</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Preset Yönetimi Sekmesi -->
            <section id="preset-management-tab" class="tab-content">
                <div class="card glass">
                    <h2 class="card-title">Preset Yönetimi (Kaydedilmiş Ayarlar)</h2>
                    <div class="form-group">
                        <label for="new-preset-name-tab">Yeni Preset Adı (Opsiyonel - Tab İçin):</label>
                        <input type="text" id="new-preset-name-tab" placeholder="AdımxÇarpanxMesafe+TP formatında otomatik">
                    </div>
                    <button id="btn-save-current-as-preset-tab" class="btn btn-primary">Mevcut Ayarları Preset Olarak Kaydet (Tab)</button>
                    
                    <h3 class="card-title" style="margin-top: 20px; font-size:1.1em;">Kaydedilmiş Presetler (Max 20)</h3>
                    <div id="preset-list-container">
                        <!-- Presetler JS ile buraya eklenecek -->
                    </div>
                </div>
            </section>

            <!-- Sonuçlar Sekmesi -->
            <section id="sonuclar-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title">Detaylı Hesaplama Sonuçları ve Senaryo Tabloları</h2>
                    <div class="collapsible-header active" data-collapsible="results-summary-text">Özet Metin</div>
                    <div class="collapsible-content active" id="results-summary-text">
                        <textarea id="results-text" readonly rows="15"></textarea>
                    </div>

                    <div class="collapsible-header" data-collapsible="results-buy-table">Alış Grid Senaryo Tablosu</div>
                    <div class="collapsible-content" id="results-buy-table">
                        <div id="buy-scenario-table-container" style="overflow-x:auto;"></div>
                    </div>
                    
                    <div class="collapsible-header" data-collapsible="results-sell-table">Satış Grid Senaryo Tablosu</div>
                    <div class="collapsible-content" id="results-sell-table">
                         <div id="sell-scenario-table-container" style="overflow-x:auto;"></div>
                    </div>
                </div>
            </section>
        </main>

        <div class="action-bar">
            <button id="btnHesapla" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M18.984 12.984h2.016v-1.969h-2.016v1.969zM18.984 15.984h2.016v-2.016h-2.016v2.016zM12.984 18.984h1.969v-2.016h-1.969v2.016zM12.984 15.984h1.969v-1.969h-1.969v1.969zM15.984 12.984h1.969v-1.969h-1.969v1.969zM12 3q1.594 0 3.094.516t2.578 1.406l-1.453 1.453q-.703-.562-1.594-.938t-1.625- .375q-2.062 0-3.516 1.453t-1.453 3.516q0 .938.375 1.781t.938 1.594l-1.406 1.406q-.938-.984-1.453-2.484t-.516-3.281q0-3.75 2.625-6.375t6.375-2.625zM21 18.984v-12q0-.797-.609-1.406t-1.406-.609h-12q-.797 0-1.406.609t-.609 1.406v12q0 .797.609 1.406t1.406.609h12q.797 0 1.406-.609t.609-1.406z"/></svg>
                Hesapla
            </button>
            <button id="btnDisaAktar" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M5.016 18.984h13.969v-2.016h-13.969v2.016zM18.984 12.984h-2.016v-3h-3.984v3h-2.016l4.031 3.984zM5.016 6.984v-1.969h13.969v1.969h-13.969z"/></svg>
                .set Aktar
            </button>
            <button id="btnKaydet" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M18.984 12.984v2.016q0 .797-.609 1.406t-1.406.609h-9.984q-.797 0-1.406-.609t-.609-1.406v-10.031q0-.797.609-1.406t1.406-.609h7.031l3.984 3.984v8.062zM12 18q.844 0 1.406-.562t.562-1.406-.562-1.453-.047-1.453h-2.812q0 .844.562 1.453t1.406.562v.844zM17.016 9h-4.031v-4.031q.422-.141.703-.047l3.328 3.328q.094.281-.047.703v0z"/></svg>
                Ayarları Kaydet
            </button>
            <button id="btnYukle" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M18.984 18.984v-6h-2.016v6h-12v-13.969h7.969v-2.016h-7.969q-.797 0-1.406.609t-.609 1.406v13.969q0 .797.609 1.406t1.406.609h12q.797 0 1.406-.609t.609-1.406zM18.984 6.984l-3-3-1.406 1.406 1.594 1.594h-5.156v2.016h5.156l-1.594 1.594 1.406 1.406 3-3z"/></svg>
                Ayarları Yükle
            </button>
            <button id="btnVarsayilan" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 17.016q.844 0 1.406-.609t.562-1.406-.562-1.406-.047-1.406h-2.812q0 .844.562 1.406t1.406.562v.844zM12.984 5.016v4.969h-1.969v-4.969h1.969zM12 2.016q4.125 0 7.078 2.953t2.953 7.078-2.953 7.031-7.078 2.906-7.078-2.906-2.953-7.031 2.953-7.078 7.078-2.953z"/></svg>
                Varsayılan
            </button>
        </div>
    </div>

    <!-- Save Preset Modal -->
    <div id="savePresetModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeSavePresetModal">&times;</span>
            <h3 class="modal-title">Preset Kaydet</h3>
            <div class="form-group">
                <label for="modalPresetName">Preset Adı:</label>
                <input type="text" id="modalPresetName" placeholder="Otomatik veya özel ad girin">
            </div>
            <div class="modal-actions">
                <button id="btnConfirmSavePreset" class="btn btn-primary">Kaydet</button>
                <button id="btnCancelSavePreset" class="btn btn-secondary">İptal</button>
            </div>
        </div>
    </div>

    <!-- Load Preset Modal -->
    <div id="loadPresetModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeLoadPresetModal">&times;</span>
            <h3 class="modal-title">Preset Yükle</h3>
            <div id="modal-preset-list">
                <!-- Presetler JS ile buraya eklenecek -->
            </div>
             <div class="modal-actions">
                <button id="btnCancelLoadPreset" class="btn btn-secondary">İptal</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>
    <div class="loader-overlay" id="loader-overlay"><div class="loader"></div></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // --- Service Worker Kaydı ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('ServiceWorker başarıyla kaydedildi, scope: ', registration.scope))
                .catch(error => console.log('ServiceWorker kaydı başarısız: ', error));
        });
    }

    // --- Sabitler ve Varsayılanlar ---
    const INSTRUMENT_PRESETS = {
        "ALTIN (XAUUSD)": { contract_size: 100.0, point_decimal_places: 2, tick_size: 0.01, currency: "USD", example_price: 2300.00, value_per_point_per_lot: 1.0, default_volatility: 3000, finnhub_symbol: "OANDA:XAU_USD" }, // 30$ ATR = 3000 points
        "BITCOIN (BTCUSD)": { contract_size: 1.0, point_decimal_places: 2, tick_size: 0.01, currency: "USD", example_price: 60000.00, value_per_point_per_lot: 0.01, default_volatility: 250000, finnhub_symbol: "BINANCE:BTCUSDT" }, // 2500$ ATR = 250000 points
        "EURUSD": { contract_size: 100000.0, point_decimal_places: 5, tick_size: 0.00001, currency: "USD", example_price: 1.08000, value_per_point_per_lot: 1.0, default_volatility: 800, finnhub_symbol: "OANDA:EUR_USD" } // 80 pips ATR = 800 points
    };

    const EA_DEFAULT_PARAMS = { 
        BuyIslemiAc: true, SellIslemiAc: true, PositionComment: "ProGridCalc_v1",
        PivotUst: 5555555555555.0, PivotAlt: 6.0,
        Alert3: true, Alert4: true, Alert5: true,
        UseTimeLimit: false, DoNotOpenAfterHour: 20, DoNotOpenAfterMinutes: 30,
        DoNotOpenBeforeHour: 2, DoNotOpenBeforeMinutes: 30,
        UseTimeLimitBreak: false, DoNotOpenAfterHourBreak: 12, DoNotOpenAfterMinutesBreak: 30,
        DoNotOpenBeforeHourBreak: 13, DoNotOpenBeforeMinutesBreak: 30,
    };

    const EA_LEVEL_DEFAULTS_BASE = { 
        SendOrder: true, LotSize: 0.01, NewPositionAddLevel: 25000, tp: 13000, sl: 1111111111
    };
    
    function fibonacci(n) {
        if (n <= 0) return 0;
        if (n === 1) return 1;
        let a = 0, b = 1;
        for (let i = 2; i <= n; i++) {
            [a, b] = [b, a + b];
        }
        return b;
    }


    // --- DOM Elementleri ---
    const getEl = (id) => document.getElementById(id);
    const instrumentSelect = getEl('instrument');
    const finnhubApiKeyInput = getEl('finnhub-api-key');
    const upperPriceRangeInput = getEl('upper-price-range');
    const lowerPriceRangeInput = getEl('lower-price-range');
    const timeframeSelect = getEl('timeframe-select');
    const fiboLevelsDisplay = getEl('fibo-levels-display');
    const startPriceInput = getEl('start-price');
    const pointDecimalsInput = getEl('point-decimals');
    const tickSizeInput = getEl('tick-size');
    const valuePerPointInput = getEl('value-per-point');
    const balanceInput = getEl('balance');
    const leverageInput = getEl('leverage');
    const contractSizeInput = getEl('contract-size');
    const volatilityInput = getEl('volatility-input');
    const volatilityValueDisplay = getEl('volatility-value-display');
    const useAtrForSmartDistanceCheckbox = getEl('use-atr-for-smart-distance');
    const riskPercentInput = getEl('risk-percent');
    
    const gridLevelCountInput = getEl('grid-level-count');
    const gridLevelCountDisplay = getEl('grid-level-count-display');
    const lotProgressionModelSelect = getEl('lot-progression-model');
    const customMultiplierGroup = getEl('custom-multiplier-group');
    const lotCustomMultiplierInput = getEl('lot-custom-multiplier');
    const lotCustomMultiplierDisplay = getEl('lot-custom-multiplier-display');
    const fiboLevelGroup = getEl('fibo-level-group');
    const fiboStrengthLevelSelect = getEl('fibo-strength-level');
    const initialLotInput = getEl('initial-lot');
    const totalLotTargetInput = getEl('total-lot-target');
    const gridDistancePointsInput = getEl('grid-distance-points');
    const gridDistancePointsDisplay = getEl('grid-distance-points-display');
    const gridDistancePointsNumInput = getEl('grid-distance-points-num');
    const defaultTpPointsInput = getEl('default-tp-points');
    const defaultTpPointsDisplay = getEl('default-tp-points-display');
    const defaultTpPointsNumInput = getEl('default-tp-points-num');
    const defaultSlPointsInput = getEl('default-sl-points');
    const defaultSlPointsDisplay = getEl('default-sl-points-display');
    const defaultSlPointsNumInput = getEl('default-sl-points-num');
    const maxLotPerOrderInput = getEl('max-lot-per-order');
    const manualGridLevelsTbody = getEl('manual-grid-levels-tbody'); 
    
    const resultsText = getEl('results-text');
    const riskMeterFill = getEl('risk-meter-fill');
    const riskMeterText = getEl('risk-meter-text');
    const marginUsageFillBuy = getEl('margin-usage-fill-buy');
    const marginUsageTextBuy = getEl('margin-usage-text-buy');
    const marginUsageFillSell = getEl('margin-usage-fill-sell');
    const marginUsageTextSell = getEl('margin-usage-text-sell');
    let pnlChart = null; 
    let riskBreakdownChart = null;
    const buyScenarioTableContainer = getEl('buy-scenario-table-container');
    const sellScenarioTableContainer = getEl('sell-scenario-table-container');

    const loaderOverlay = getEl('loader-overlay');
    const toastContainer = getEl('toast-container');
    
    // Preset Management (Tab)
    const presetListContainerTab = getEl('preset-list-container');
    const newPresetNameInputTab = getEl('new-preset-name-tab');

    // Modal Elements
    const savePresetModal = getEl('savePresetModal');
    const loadPresetModal = getEl('loadPresetModal');
    const modalPresetNameInput = getEl('modalPresetName');
    const modalPresetList = getEl('modal-preset-list');

    
    const eaParams = { 
        PositionComment: getEl('ea-position-comment'),
        BuyIslemiAc: getEl('ea-buy-islemi-ac'),
        SellIslemiAc: getEl('ea-sell-islemi-ac'),
        PivotUst: getEl('ea-pivot-ust'),
        PivotAlt: getEl('ea-pivot-alt'),
        Alert3: getEl('ea-alert3'), Alert4: getEl('ea-alert4'), Alert5: getEl('ea-alert5'),
        UseTimeLimit: getEl('ea-use-time-limit'),
        DoNotOpenBeforeHour: getEl('ea-before-hour'), DoNotOpenBeforeMinutes: getEl('ea-before-min'),
        DoNotOpenAfterHour: getEl('ea-after-hour'), DoNotOpenAfterMinutes: getEl('ea-after-min'),
        UseTimeLimitBreak: getEl('ea-use-time-limit-break'),
        DoNotOpenAfterHourBreak: getEl('ea-after-hour-break'), DoNotOpenAfterMinutesBreak: getEl('ea-after-min-break'),
        DoNotOpenBeforeHourBreak: getEl('ea-before-hour-break'), DoNotOpenBeforeMinutesBreak: getEl('ea-before-min-break'),
    };

    let levelInputFields = []; 

    // --- Uygulama Başlatma ---
    document.addEventListener('DOMContentLoaded', initApp);

    function initApp() {
        const currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', currentTheme);
        getEl('theme-toggle-btn').innerHTML = currentTheme === 'dark' ? '☀️' : '🌙';

        for (const instrName in INSTRUMENT_PRESETS) {
            const option = document.createElement('option');
            option.value = instrName;
            option.textContent = instrName;
            instrumentSelect.appendChild(option);
        }
        instrumentSelect.value = "ALTIN (XAUUSD)"; 
        
        setupEventListeners();
        handleInstrumentChange(); 
        createLevelInputs();    
        loadEADefaultsToUI();   
        loadAppSettingsFromLocalStorage(); 
        loadPresetsFromStorage(); 
        
        updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
        updateSliderDisplay(lotCustomMultiplierInput, lotCustomMultiplierDisplay, 2); 
        updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
        gridDistancePointsNumInput.value = gridDistancePointsInput.value; 
        updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
        defaultTpPointsNumInput.value = defaultTpPointsInput.value;
        updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
        defaultSlPointsNumInput.value = defaultSlPointsInput.value;
        updateSliderDisplay(volatilityInput, volatilityValueDisplay);
        
        handleLotProgressionChange(); 
        applyLotProgressionAndPopulateManualGrid(); 
        
        switchTab('temel-ayarlar-tab'); 
        ['pivot-settings', 'alert-settings', 'time-filter-settings', 'auto-grid-config', 'results-summary-text'].forEach(id => {
            const header = document.querySelector(`.collapsible-header[data-collapsible="${id}"]`);
            const content = document.getElementById(id);
            if (header && content) {
                header.classList.add('active');
                content.classList.add('active');
            }
        });
        calculateAndDisplayGrid(); 
        console.log("Pro Grid Calculator UI Initialized (Full functionality attempt)");
    }

    function setupEventListeners() {
        getEl('theme-toggle-btn').addEventListener('click', () => {
            let newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            getEl('theme-toggle-btn').innerHTML = newTheme === 'dark' ? '☀️' : '🌙';
            if (navigator.vibrate) navigator.vibrate(50);
            updateChartTheme(); 
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });
        
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                header.classList.toggle('active');
                const content = document.getElementById(header.dataset.collapsible);
                if (content) content.classList.toggle('active');
                if (navigator.vibrate) navigator.vibrate(30);
            });
        });

        instrumentSelect.addEventListener('change', () => {
            handleInstrumentChange();
            applyLotProgressionAndPopulateManualGrid(); 
            calculateAndDisplayGrid(); 
        });
        [startPriceInput, balanceInput, leverageInput, contractSizeInput, pointDecimalsInput, tickSizeInput, valuePerPointInput, volatilityInput, useAtrForSmartDistanceCheckbox, riskPercentInput, upperPriceRangeInput, lowerPriceRangeInput, timeframeSelect, finnhubApiKeyInput].forEach(input => {
            input.addEventListener('input', () => {
                if(input.type === 'range') updateSliderDisplay(input, input.labels[0].querySelector('span'));
                if(input.id === 'volatility-input' || input.id === 'use-atr-for-smart-distance') calculateSmartDistance(); 
                if(input.id === 'timeframe-select' || input.id === 'start-price' || input.id === 'volatility-input' || input.id === 'finnhub-api-key') autoSetFiboPriceRange(false); // Don't auto-apply, just display
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            });
             input.addEventListener('change', () => { // For select elements like timeframe
                if(input.id === 'timeframe-select' || input.id === 'start-price' || input.id === 'volatility-input' || input.id === 'finnhub-api-key') autoSetFiboPriceRange(false);
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            });
        });
        getEl('btn-auto-fibo-range').addEventListener('click', () => autoSetFiboPriceRange(true)); // True to apply to inputs
        
        gridLevelCountInput.addEventListener('input', () => {
            updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
            createLevelInputs(); 
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });
        lotProgressionModelSelect.addEventListener('change', () => {
            handleLotProgressionChange();
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });
        lotCustomMultiplierInput.addEventListener('input', () => {
            updateSliderDisplay(lotCustomMultiplierInput, lotCustomMultiplierDisplay, 2);
            if (lotProgressionModelSelect.value === 'custom_multiplier') {
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            }
        });
        [initialLotInput, totalLotTargetInput, maxLotPerOrderInput, fiboStrengthLevelSelect].forEach(input => {
            input.addEventListener('input', () => {
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            });
             input.addEventListener('change', () => { 
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            });
        });

        gridDistancePointsInput.addEventListener('input', () => {
            updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
            gridDistancePointsNumInput.value = gridDistancePointsInput.value; 
            applyLotProgressionAndPopulateManualGrid(); 
            calculateAndDisplayGrid();
        });
         gridDistancePointsNumInput.addEventListener('input', () => {
            gridDistancePointsInput.value = gridDistancePointsNumInput.value; 
            updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay); 
            applyLotProgressionAndPopulateManualGrid(); 
            calculateAndDisplayGrid();
        });
        
        // Default TP/SL dual controls
        defaultTpPointsInput.addEventListener('input', () => {
            updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
            defaultTpPointsNumInput.value = defaultTpPointsInput.value;
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });
        defaultTpPointsNumInput.addEventListener('input', () => {
            defaultTpPointsInput.value = defaultTpPointsNumInput.value;
            updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });
        defaultSlPointsInput.addEventListener('input', () => {
            updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
            defaultSlPointsNumInput.value = defaultSlPointsInput.value;
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });
        defaultSlPointsNumInput.addEventListener('input', () => {
            defaultSlPointsInput.value = defaultSlPointsNumInput.value;
            updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
            applyLotProgressionAndPopulateManualGrid();
            calculateAndDisplayGrid();
        });


        getEl('btn-smart-distance').addEventListener('click', calculateSmartDistance);
        getEl('btn-apply-auto-to-manual').addEventListener('click', () => {
            applyLotProgressionAndPopulateManualGrid();
            showToast("Otomatik ayarlar manuel tabloya başarıyla uygulandı!", "success");
        });


        getEl('btnHesapla').addEventListener('click', () => {
            showLoader();
            setTimeout(() => {
                calculateAndDisplayGrid();
                hideLoader();
                showToast("Hesaplama tamamlandı!", "success");
            }, 500);
        });
        getEl('btnDisaAktar').addEventListener('click', exportSetFile);
        
        // Modal Save/Load buttons
        getEl('btnKaydet').addEventListener('click', openSavePresetModal);
        getEl('btnYukle').addEventListener('click', openLoadPresetModal);

        getEl('btnVarsayilan').addEventListener('click', loadEADefaultsToUI);

        getEl('preset-gold').addEventListener('click', () => loadInstrumentPreset("ALTIN (XAUUSD)"));
        getEl('preset-btc').addEventListener('click', () => loadInstrumentPreset("BITCOIN (BTCUSD)"));
        getEl('preset-eurusd').addEventListener('click', () => loadInstrumentPreset("EURUSD"));

        getEl('scenario-conservative').addEventListener('click', () => applyScenario('conservative'));
        getEl('scenario-moderate').addEventListener('click', () => applyScenario('moderate'));
        getEl('scenario-aggressive').addEventListener('click', () => applyScenario('aggressive'));

        getEl('btn-save-current-as-preset-tab').addEventListener('click', () => saveCurrentSettingsAsPreset(newPresetNameInputTab.value));
        
        // Modal event listeners
        getEl('closeSavePresetModal').addEventListener('click', () => savePresetModal.style.display = "none");
        getEl('btnCancelSavePreset').addEventListener('click', () => savePresetModal.style.display = "none");
        getEl('btnConfirmSavePreset').addEventListener('click', confirmSavePresetFromModal);

        getEl('closeLoadPresetModal').addEventListener('click', () => loadPresetModal.style.display = "none");
        getEl('btnCancelLoadPreset').addEventListener('click', () => loadPresetModal.style.display = "none");

        window.addEventListener('click', (event) => { // Close modal if clicked outside
            if (event.target == savePresetModal) savePresetModal.style.display = "none";
            if (event.target == loadPresetModal) loadPresetModal.style.display = "none";
        });
    }
    
    function updateSliderDisplay(slider, displayElement, decimals = 0) {
        if (displayElement && slider) { 
            displayElement.textContent = parseFloat(slider.value).toFixed(decimals);
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
        const tabElement = getEl(tabId);
        if(tabElement) tabElement.classList.add('active');
        const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
        if (activeButton) activeButton.classList.add('active');
        if (navigator.vibrate) navigator.vibrate(30);
    }
    
    function handleInstrumentChange() {
        const selectedInstrName = instrumentSelect.value;
        const preset = INSTRUMENT_PRESETS[selectedInstrName];
        if (preset) {
            startPriceInput.value = preset.example_price;
            pointDecimalsInput.value = preset.point_decimal_places;
            tickSizeInput.value = preset.tick_size;
            valuePerPointInput.value = preset.value_per_point_per_lot;
            contractSizeInput.value = preset.contract_size;
            volatilityInput.value = preset.default_volatility;
            updateSliderDisplay(volatilityInput, volatilityValueDisplay);
            calculateSmartDistance(); 
            autoSetFiboPriceRange(false); // Display Fibo levels for new instrument
        }
    }

    function createLevelInputs() {
        manualGridLevelsTbody.innerHTML = '';
        levelInputFields = [];
        const levelCount = parseInt(gridLevelCountInput.value) || 14; 

        for (let i = 0; i < levelCount; i++) {
            const tr = document.createElement('tr');
            const levelData = { // Simple number inputs for manual table
                SendOrder: document.createElement('input'),
                LotSize: document.createElement('input'),
                NewPositionAddLevel: document.createElement('input'),
                tp: document.createElement('input'),
                sl: document.createElement('input'),
            };

            let td = document.createElement('td'); td.textContent = i + 1; tr.appendChild(td);
            
            td = document.createElement('td'); levelData.SendOrder.type = 'checkbox'; levelData.SendOrder.checked = EA_LEVEL_DEFAULTS_BASE.SendOrder; levelData.SendOrder.addEventListener('change', calculateAndDisplayGrid); td.appendChild(levelData.SendOrder); tr.appendChild(td);
            
            td = document.createElement('td'); levelData.LotSize.type = 'number'; levelData.LotSize.step = '0.01'; levelData.LotSize.min = '0.01'; levelData.LotSize.value = EA_LEVEL_DEFAULTS_BASE.LotSize; levelData.LotSize.addEventListener('input', calculateAndDisplayGrid); td.appendChild(levelData.LotSize); tr.appendChild(td);
            
            td = document.createElement('td'); 
            levelData.NewPositionAddLevel.type = 'number'; levelData.NewPositionAddLevel.step = '1'; levelData.NewPositionAddLevel.min = '0';
            levelData.NewPositionAddLevel.value = (i === 0) ? 0 : EA_LEVEL_DEFAULTS_BASE.NewPositionAddLevel;
            levelData.NewPositionAddLevel.disabled = (i === 0);
            levelData.NewPositionAddLevel.addEventListener('input', calculateAndDisplayGrid);
            td.appendChild(levelData.NewPositionAddLevel); tr.appendChild(td);
            
            td = document.createElement('td'); 
            levelData.tp.type = 'number'; levelData.tp.step = '1'; levelData.tp.min = '0';
            levelData.tp.value = EA_LEVEL_DEFAULTS_BASE.tp;
            levelData.tp.addEventListener('input', calculateAndDisplayGrid);
            td.appendChild(levelData.tp); tr.appendChild(td);
            
            td = document.createElement('td'); 
            levelData.sl.type = 'number'; levelData.sl.step = '1'; levelData.sl.min = '0';
            levelData.sl.value = EA_LEVEL_DEFAULTS_BASE.sl;
            levelData.sl.addEventListener('input', calculateAndDisplayGrid);
            td.appendChild(levelData.sl); tr.appendChild(td);
            
            manualGridLevelsTbody.appendChild(tr);
            levelInputFields.push(levelData);
        }
    }
    
    function handleLotProgressionChange() {
        const model = lotProgressionModelSelect.value;
        customMultiplierGroup.style.display = (model === 'custom_multiplier') ? 'block' : 'none';
        fiboLevelGroup.style.display = (model === 'fibonacci_weighted') ? 'block' : 'none';
    }

    function applyLotProgressionAndPopulateManualGrid() {
        const levelCount = parseInt(gridLevelCountInput.value);
        const model = lotProgressionModelSelect.value;
        const initialLot = parseFloat(initialLotInput.value) || 0.01;
        const customMultiplier = parseFloat(lotCustomMultiplierInput.value) || 1.5;
        let defaultDistance = parseInt(gridDistancePointsNumInput.value) || 0; 
        const defaultTp = parseInt(defaultTpPointsNumInput.value) || EA_LEVEL_DEFAULTS_BASE.tp;
        const defaultSl = parseInt(defaultSlPointsNumInput.value) || EA_LEVEL_DEFAULTS_BASE.sl;
        const targetTotalLot = parseFloat(totalLotTargetInput.value) || 0; 
        const maxLotPerOrd = parseFloat(maxLotPerOrderInput.value) || Infinity;
        const fiboStrength = parseFloat(fiboStrengthLevelSelect.value) || 0.618;


        const upperRange = parseFloat(upperPriceRangeInput.value);
        const lowerRange = parseFloat(lowerPriceRangeInput.value);
        const startP = parseFloat(startPriceInput.value);

        if (!isNaN(upperRange) && !isNaN(lowerRange) && !isNaN(startP) && upperRange > lowerRange && levelCount > 1) {
            const totalRangeForGrid = Math.abs(upperRange - lowerRange); 
            const tickSz = parseFloat(tickSizeInput.value) || 0.01;
            if (tickSz > 0) {
                 const avgDistancePoints = Math.round((totalRangeForGrid / tickSz) / (levelCount -1));
                 defaultDistance = Math.max(0, avgDistancePoints); 
                 gridDistancePointsInput.value = defaultDistance; 
                 gridDistancePointsNumInput.value = defaultDistance;
                 updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
            }
        }


        let lots = [];
        let currentLot = initialLot;

        for (let i = 0; i < levelCount; i++) {
            if (i === 0) {
                currentLot = Math.min(initialLot, maxLotPerOrd);
                lots.push(currentLot);
            } else {
                let nextLot = currentLot;
                switch (model) {
                    case 'linear': nextLot = initialLot; break;
                    case 'martingale': nextLot *= 2; break;
                    case 'custom_multiplier': nextLot *= customMultiplier; break;
                    case 'fibonacci_weighted':
                        nextLot *= (1 + fiboStrength); 
                        break;
                    case 'fibonacci': 
                        nextLot = initialLot * fibonacci(i + 1); 
                        break;
                    case 'custom_sequence': 
                        nextLot = (levelInputFields[i] && levelInputFields[i].LotSize) ? parseFloat(levelInputFields[i].LotSize.value) : currentLot;
                        break;
                }
                currentLot = Math.min(Math.max(0.01, parseFloat(nextLot.toFixed(2))), maxLotPerOrd);
                lots.push(currentLot);
            }
        }
        
        if (targetTotalLot > 0 && model !== 'custom_sequence') {
            const currentTotalLot = lots.reduce((sum, lot) => sum + lot, 0);
            if (currentTotalLot > 0 && currentTotalLot !== targetTotalLot) {
                const ratio = targetTotalLot / currentTotalLot;
                lots = lots.map(lot => Math.min(Math.max(0.01, parseFloat((lot * ratio).toFixed(2))), maxLotPerOrd));
            }
        }

        levelInputFields.forEach((levelUI, i) => {
            if (i < levelCount) { 
                if (model !== 'custom_sequence') { 
                    levelUI.LotSize.value = lots[i].toFixed(2);
                }
                levelUI.SendOrder.checked = true; 
                levelUI.NewPositionAddLevel.value = (i === 0) ? 0 : defaultDistance;
                levelUI.tp.value = defaultTp; 
                levelUI.sl.value = defaultSl;
            }
        });
    }
    
    function calculateSmartDistance() {
        if (!useAtrForSmartDistanceCheckbox.checked) return;
        const volatility = parseFloat(volatilityInput.value) || 3000; 
        const smartDist = Math.round(volatility * 0.15 / 100) * 100; 
        gridDistancePointsInput.value = Math.max(0, smartDist); 
        gridDistancePointsNumInput.value = gridDistancePointsInput.value;
        updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
    }

    function loadInstrumentPreset(instrumentName) {
        instrumentSelect.value = instrumentName;
        handleInstrumentChange(); 
        
        if (instrumentName === "ALTIN (XAUUSD)") {
            gridLevelCountInput.value = 14; 
            updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
            createLevelInputs(); 
            
            lotProgressionModelSelect.value = "martingale";
            initialLotInput.value = 0.01;
            gridDistancePointsNumInput.value = 3500;
            gridDistancePointsInput.value = 3500;
            updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
            defaultTpPointsNumInput.value = 7000; defaultTpPointsInput.value = 7000; updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
            defaultSlPointsNumInput.value = 60000; defaultSlPointsInput.value = 60000; updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
            
            const goldOptimizedLevels = [ 
                { SendOrder: true, LotSize: 0.01, NewPositionAddLevel: 0,    tp: 7000, sl: 60000 },
                { SendOrder: true, LotSize: 0.02, NewPositionAddLevel: 3500, tp: 7000, sl: 60000 },
                { SendOrder: true, LotSize: 0.04, NewPositionAddLevel: 3500, tp: 7000, sl: 60000 },
                { SendOrder: true, LotSize: 0.08, NewPositionAddLevel: 3500, tp: 7000, sl: 60000 },
                { SendOrder: true, LotSize: 0.16, NewPositionAddLevel: 3500, tp: 7000, sl: 60000 }
            ];
            levelInputFields.forEach((levelUI, i) => {
                const defaults = (i < goldOptimizedLevels.length) ? goldOptimizedLevels[i] : 
                                 { SendOrder: (i < 5), LotSize: (i < 5 && goldOptimizedLevels[i]) ? goldOptimizedLevels[i].LotSize : 0.01, NewPositionAddLevel: 3500, tp: 7000, sl: 60000 };
                levelUI.SendOrder.checked = defaults.SendOrder;
                levelUI.LotSize.value = parseFloat(defaults.LotSize).toFixed(2);
                levelUI.NewPositionAddLevel.value = (i === 0) ? 0 : defaults.NewPositionAddLevel;
                levelUI.tp.value = defaults.tp;
                levelUI.sl.value = defaults.sl;
            });
        } else {
            applyLotProgressionAndPopulateManualGrid();
        }
        handleLotProgressionChange(); 
        calculateAndDisplayGrid();
        showToast(instrumentName + " için optimize edilmiş ayarlar yüklendi.", "info");
    }
    
    function applyScenario(scenarioType) {
        const riskP = parseFloat(riskPercentInput.value) || 5;
        let scenarioDistanceFactor = 0.15; // Moderate
        if(scenarioType === 'conservative') scenarioDistanceFactor = 0.25;
        if(scenarioType === 'aggressive') scenarioDistanceFactor = 0.10;

        gridLevelCountInput.value = (scenarioType === 'conservative') ? 7 : (scenarioType === 'aggressive' ? 14 : 10);
        lotProgressionModelSelect.value = (scenarioType === 'conservative') ? 'linear' : 'martingale';
        initialLotInput.value = (scenarioType === 'aggressive') ? 0.02 : 0.01;
        gridDistancePointsNumInput.value = Math.round((parseFloat(volatilityInput.value) || 3000) * scenarioDistanceFactor / 100) * 100;
        gridDistancePointsInput.value = gridDistancePointsNumInput.value;
        totalLotTargetInput.value = ""; 

        updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
        updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
        handleLotProgressionChange();
        applyLotProgressionAndPopulateManualGrid();
        calculateAndDisplayGrid();
        showToast(scenarioType + " senaryosu uygulandı.", "info");
    }
    
    function updateGauge(fillElement, textElement, percentage, labelPrefix = "") {
        percentage = Math.max(0, Math.min(100, percentage)); 
        const angle = (percentage / 100) * 180; 
        if (fillElement) fillElement.style.transform = `rotate(${angle}deg)`;
        if (textElement) textElement.textContent = labelPrefix + percentage.toFixed(1) + "%";

        if (fillElement) {
            if (percentage > 75) fillElement.style.backgroundColor = 'var(--danger-color)';
            else if (percentage > 40) fillElement.style.backgroundColor = 'var(--accent-color)';
            else fillElement.style.backgroundColor = 'var(--success-color)';
        }
    }
    
    function updateRiskMeters(buyMarginPercent, sellMarginPercent, totalRiskPercent) {
        updateGauge(marginUsageFillBuy, marginUsageTextBuy, buyMarginPercent);
        updateGauge(marginUsageFillSell, marginUsageTextSell, sellMarginPercent);

        const riskLevelNum = Math.max(buyMarginPercent, sellMarginPercent, totalRiskPercent || 0);
        let riskLevelText = "Düşük";
        let riskColor = 'var(--success-color)';

        if (riskLevelNum > 50) { riskLevelText = "ÇOK YÜKSEK!"; riskColor = 'var(--danger-color)'; }
        else if (riskLevelNum > 30) { riskLevelText = "Yüksek"; riskColor = 'var(--danger-color)';}
        else if (riskLevelNum > 15) { riskLevelText = "Orta"; riskColor = 'var(--accent-color)';}
        
        if(riskMeterFill) riskMeterFill.style.transform = `rotate(${(riskLevelNum / 100) * 180}deg)`;
        if(riskMeterFill) riskMeterFill.style.backgroundColor = riskColor;
        if(riskMeterText) riskMeterText.textContent = riskLevelText;
    }

    function updateChartTheme() {
        const chartsToUpdate = [pnlChart, riskBreakdownChart];
        chartsToUpdate.forEach(chartInstance => {
            if (chartInstance) {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = currentTheme === 'dark' ? '#c9d1d9' : '#2c3e50';

                if (chartInstance.options.scales.x) {
                    chartInstance.options.scales.x.grid.color = gridColor;
                    chartInstance.options.scales.x.ticks.color = textColor;
                }
                if (chartInstance.options.scales.y) {
                    chartInstance.options.scales.y.grid.color = gridColor;
                    chartInstance.options.scales.y.ticks.color = textColor;
                }
                 if (chartInstance.options.plugins && chartInstance.options.plugins.legend) {
                    chartInstance.options.plugins.legend.labels.color = textColor;
                }
                chartInstance.update();
            }
        });
    }

    function renderPnlChart(buyData, sellData) {
        const ctx = document.getElementById('gridPnlChart').getContext('2d');
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = currentTheme === 'dark' ? '#c9d1d9' : '#2c3e50';

        const labels = Array.from({ length: Math.max(buyData.levels.length, sellData.levels.length) }, (_, i) => `Lvl ${i + 1}`);

        if (pnlChart) pnlChart.destroy();

        pnlChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Alış Grid Kümülatif P&L',
                        data: buyData.levels.map(l => l.cumulativePnlAtGroupTp),
                        backgroundColor: 'rgba(52, 152, 219, 0.7)', 
                        borderColor: 'rgba(41, 128, 185, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Satış Grid Kümülatif P&L',
                        data: sellData.levels.map(l => l.cumulativePnlAtGroupTp),
                        backgroundColor: 'rgba(230, 126, 34, 0.7)', 
                        borderColor: 'rgba(211, 84, 0, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: function(value) { return value + ' ' + buyData.currency; } } }
                },
                plugins: { legend: { labels: { color: textColor } }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2) + ' ' + buyData.currency; } return label; } } } }
            }
        });
    }

    function renderRiskBreakdownChart(buyDD, sellDD, currency) {
        const ctx = document.getElementById('riskBreakdownChart').getContext('2d');
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const textColor = currentTheme === 'dark' ? '#c9d1d9' : '#2c3e50';

        if (riskBreakdownChart) riskBreakdownChart.destroy();

        riskBreakdownChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Max DD Alış', 'Max DD Satış'],
                datasets: [{
                    label: 'Risk Dağılımı',
                    data: [Math.abs(buyDD), Math.abs(sellDD)],
                    backgroundColor: [ 'rgba(231, 76, 60, 0.7)', 'rgba(241, 196, 15, 0.7)' ], // Red, Yellow
                    borderColor: [ 'rgba(192, 57, 43, 1)', 'rgba(243, 156, 18, 1)' ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { color: textColor } }, tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed.toFixed(2) + ' ' + currency; } } } }
            }
        });
    }

    function renderScenarioTable(containerId, side, data, currency, pointDecimals) {
        const container = getEl(containerId);
        container.innerHTML = '';
        if (!data || data.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:var(--text-muted-color);">Bu yön için aktif grid seviyesi yok.</p>`;
            return;
        }

        let tableHTML = `<table class="level-table" style="font-size:0.8em;"><thead><tr>
            <th>Lvl</th><th>Lot</th><th>Giriş</th><th>Küm.Lot</th><th>Ort.Giriş</th>
            <th>Grup TP Fiyatı</th><th>Küm. P&L @ TP</th><th>DD (Sonraki)</th><th>Marjin</th>
            </tr></thead><tbody>`;

        let cumulativeLot = 0;
        let weightedPriceSum = 0;

        data.forEach(lvl => {
            cumulativeLot += lvl.lot;
            weightedPriceSum += lvl.entry * lvl.lot;
            const avgEntry = cumulativeLot > 0 ? weightedPriceSum / cumulativeLot : 0;
            tableHTML += `<tr>
                <td>${lvl.level}</td>
                <td>${lvl.lot.toFixed(2)}</td>
                <td>${lvl.entry.toFixed(pointDecimals)}</td>
                <td>${cumulativeLot.toFixed(2)}</td>
                <td>${avgEntry.toFixed(pointDecimals)}</td>
                <td>${lvl.groupTpPriceIfThisIsLast.toFixed(pointDecimals)}</td>
                <td style="color:${lvl.cumulativePnlAtGroupTp >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight:bold;">${lvl.cumulativePnlAtGroupTp.toFixed(2)} ${currency}</td>
                <td style="color:var(--danger-color);">${lvl.potentialDrawdownBeforeNext.toFixed(2)} ${currency}</td>
                <td>${lvl.margin.toFixed(2)} ${currency}</td>
            </tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }


    function collectInputs() {
        const inputs = {
            instrumentName: instrumentSelect.value,
            finnhubApiKey: finnhubApiKeyInput.value.trim(),
            upperPriceRange: parseFloat(upperPriceRangeInput.value) || null,
            lowerPriceRange: parseFloat(lowerPriceRangeInput.value) || null,
            timeframe: timeframeSelect.value,
            startPrice: parseFloat(startPriceInput.value) || 0,
            pointDecimals: parseInt(pointDecimalsInput.value) || 0,
            tickSize: parseFloat(tickSizeInput.value) || 0,
            valuePerPointPerLot: parseFloat(valuePerPointInput.value) || 0,
            balance: parseFloat(balanceInput.value) || 0,
            leverage: parseInt(leverageInput.value) || 1,
            contractSize: parseFloat(contractSizeInput.value) || 0,
            riskPercent: parseFloat(riskPercentInput.value) || 0,
            volatilityInput: parseFloat(volatilityInput.value) || 0, // Store slider value too
            useAtrForSmartDistance: useAtrForSmartDistanceCheckbox.checked,
            
            gridLevelCount: parseInt(gridLevelCountInput.value) || 14,
            lotProgressionModel: lotProgressionModelSelect.value,
            lotCustomMultiplier: parseFloat(lotCustomMultiplierInput.value) || 1.5,
            fiboStrength: parseFloat(fiboStrengthLevelSelect.value) || 0.618,
            initialLot: parseFloat(initialLotInput.value) || 0.01,
            totalLotTarget: parseFloat(totalLotTargetInput.value) || 0,
            defaultGridDistance: parseInt(gridDistancePointsNumInput.value) || 0, 
            defaultTp: parseInt(defaultTpPointsNumInput.value) || EA_LEVEL_DEFAULTS_BASE.tp,
            defaultSl: parseInt(defaultSlPointsNumInput.value) || EA_LEVEL_DEFAULTS_BASE.sl,
            maxLotPerOrder: parseFloat(maxLotPerOrderInput.value) || Infinity,
            
            manualLevels: [],
            ea: {}
        };

        levelInputFields.forEach(levelUI => {
            inputs.manualLevels.push({ // Reading from simple number inputs now
                SendOrder: levelUI.SendOrder.checked,
                LotSize: parseFloat(levelUI.LotSize.value) || 0.01,
                NewPositionAddLevel: parseInt(levelUI.NewPositionAddLevel.value) || 0,
                tp: parseInt(levelUI.tp.value) || 0,
                sl: parseInt(levelUI.sl.value) || 0,
            });
        });
        
        for(const key in eaParams) {
            if (eaParams[key].type === 'checkbox') {
                inputs.ea[key] = eaParams[key].checked;
            } else if (eaParams[key].type === 'number' || (eaParams[key].nodeName === 'INPUT' && eaParams[key].inputMode === 'numeric') ) {
                inputs.ea[key] = parseFloat(eaParams[key].value) || 0;
            } else {
                 inputs.ea[key] = eaParams[key].value || "";
            }
        }
        return inputs;
    }

    function calculateAndDisplayGrid() {
        try {
            const inputs = collectInputs();
            if (isNaN(inputs.startPrice) || isNaN(inputs.balance) || isNaN(inputs.leverage) || 
                isNaN(inputs.contractSize) || isNaN(inputs.pointDecimals) || 
                isNaN(inputs.tickSize) || isNaN(inputs.valuePerPointPerLot) || inputs.tickSize === 0) {
                resultsText.value = "Lütfen temel hesap ve enstrüman ayarları için geçerli sayılar girin (Tick Size 0 olamaz).";
                updateRiskMeters(0,0,0);
                renderPnlChart({levels:[], currency: ""}, {levels:[], currency: ""}); 
                renderRiskBreakdownChart(0,0, "");
                renderScenarioTable('buy-scenario-table-container', 'BUY', [], "", 0);
                renderScenarioTable('sell-scenario-table-container', 'SELL', [], "", 0);
                return;
            }

            const instrDetails = INSTRUMENT_PRESETS[inputs.instrumentName];
            let results = `--- Grid Hesaplama Sonuçları (${inputs.instrumentName}) ---\n`;
            results += `Başlangıç Fiyatı: ${inputs.startPrice.toFixed(inputs.pointDecimals)} ${instrDetails.currency}\n`;
            results += `Hesap Bakiyesi: ${inputs.balance.toFixed(2)} ${instrDetails.currency}\n`;
            results += `Kaldıraç: 1:${inputs.leverage}\n`;
            results += `Kontrat Büyüklüğü: ${inputs.contractSize}\n`;
            results += `Tick Büyüklüğü (1 Puan): ${inputs.tickSize.toFixed(Math.max(2, inputs.pointDecimals))}\n`;
            results += `1 Puan Değeri (1 Lot): ${inputs.valuePerPointPerLot.toFixed(2)}\n`;
            if(inputs.riskPercent > 0) results += `Hedef Risk Yüzdesi: ${inputs.riskPercent.toFixed(1)}%\n`;
            results += "\n";

            let buyGridDataForChart = { levels: [], currency: instrDetails.currency };
            let sellGridDataForChart = { levels: [], currency: instrDetails.currency };
            let totalBuyMarginPercent = 0;
            let totalSellMarginPercent = 0;
            let maxCalculatedDrawdownBuy = 0;
            let maxCalculatedDrawdownSell = 0;

            function processSide(side) {
                let total_lots = 0;
                let total_margin_needed = 0;
                let cumulative_distance_points = 0;
                const active_levels_data = [];
                let weighted_sum_price_lots = 0;
                let current_drawdown_at_worst_point = 0;
                let max_drawdown_for_this_side = 0;

                for (let i = 0; i < inputs.manualLevels.length; i++) { 
                    const level_cfg = inputs.manualLevels[i];
                    if (!level_cfg.SendOrder) continue;

                    const lot = level_cfg.LotSize;
                    if (isNaN(lot) || lot <= 0) continue;

                    const tp_points = level_cfg.tp;
                    const sl_points = level_cfg.sl;
                    const npl_points = (i > 0) ? level_cfg.NewPositionAddLevel : 0;

                    let entry_price;
                    if (i === 0) {
                        entry_price = inputs.startPrice;
                    } else {
                        cumulative_distance_points += npl_points;
                        entry_price = (side === 'BUY') ?
                            inputs.startPrice - (cumulative_distance_points * inputs.tickSize) :
                            inputs.startPrice + (cumulative_distance_points * inputs.tickSize);
                    }
                    
                    const group_tp_price_at_this_level = (side === 'BUY') ? entry_price + (tp_points * inputs.tickSize) : entry_price - (tp_points * inputs.tickSize);
                    const sl_price = (side === 'BUY') ? entry_price - (sl_points * inputs.tickSize) : entry_price + (sl_points * inputs.tickSize);
                    
                    const margin_per_lot_this_level = (inputs.contractSize * entry_price) / inputs.leverage;
                    const margin_this_level = lot * margin_per_lot_this_level;
                    
                    total_lots += lot;
                    weighted_sum_price_lots += entry_price * lot;
                    total_margin_needed += margin_this_level;

                    const avg_entry_price_so_far = total_lots > 0 ? weighted_sum_price_lots / total_lots : 0;
                    let pnl_at_group_tp = 0;
                    if (total_lots > 0 && inputs.tickSize > 0) {
                        const price_diff_points_for_group_tp = (side === 'BUY') ? 
                            (group_tp_price_at_this_level - avg_entry_price_so_far) / inputs.tickSize :
                            (avg_entry_price_so_far - group_tp_price_at_this_level) / inputs.tickSize;
                        pnl_at_group_tp = price_diff_points_for_group_tp * total_lots * inputs.valuePerPointPerLot;
                    }

                    let worst_price_before_tp = sl_price; 
                    if (i + 1 < inputs.manualLevels.length && inputs.manualLevels[i+1].SendOrder) {
                        const next_npl_for_dd_calc = inputs.manualLevels[i+1].NewPositionAddLevel; // Use next level's NPL for DD calc
                        worst_price_before_tp = (side === 'BUY') ? 
                            entry_price - (next_npl_for_dd_calc * inputs.tickSize) : // Price drops to open next buy
                            entry_price + (next_npl_for_dd_calc * inputs.tickSize); // Price rises to open next sell
                    }
                    
                    let drawdown_if_next_level_opens = 0;
                    if (total_lots > 0 && inputs.tickSize > 0) {
                         const dd_price_diff_points = (side === 'BUY') ?
                            (avg_entry_price_so_far - worst_price_before_tp) / inputs.tickSize :
                            (worst_price_before_tp - avg_entry_price_so_far) / inputs.tickSize;
                        drawdown_if_next_level_opens = dd_price_diff_points * total_lots * inputs.valuePerPointPerLot; 
                    }
                    max_drawdown_for_this_side = Math.min(max_drawdown_for_this_side, drawdown_if_next_level_opens);


                    active_levels_data.push({
                        level: i + 1, lot: lot, entry: entry_price, 
                        groupTpPriceIfThisIsLast: group_tp_price_at_this_level, 
                        sl: sl_price, 
                        margin: margin_this_level, npl_cumulative: cumulative_distance_points,
                        cumulativePnlAtGroupTp: pnl_at_group_tp, 
                        potentialDrawdownBeforeNext: drawdown_if_next_level_opens
                    });
                }

                if (active_levels_data.length === 0) {
                    results += `--- ${side} GRID ---\nAktif ${side.toLowerCase()} kademesi yok.\n\n`;
                    if (side === 'BUY') {totalBuyMarginPercent = 0; maxCalculatedDrawdownBuy = 0; buyGridDataForChart.levels = [];}
                    else {totalSellMarginPercent = 0; maxCalculatedDrawdownSell = 0; sellGridDataForChart.levels = [];}
                    return;
                }
                
                const final_avg_entry_price = total_lots > 0 ? weighted_sum_price_lots / total_lots : 0;
                const final_group_tp_price = active_levels_data[active_levels_data.length - 1].groupTpPriceIfThisIsLast; 
                const final_potential_profit = active_levels_data[active_levels_data.length - 1].cumulativePnlAtGroupTp;
                
                const margin_percent_of_balance = (inputs.balance > 0 ? (total_margin_needed / inputs.balance * 100) : 0);
                const drawdown_percent_of_balance = (inputs.balance > 0 ? (Math.abs(max_drawdown_for_this_side) / inputs.balance * 100) : 0);


                if (side === 'BUY') {
                    totalBuyMarginPercent = margin_percent_of_balance;
                    maxCalculatedDrawdownBuy = Math.abs(max_drawdown_for_this_side);
                    buyGridDataForChart.levels = active_levels_data;
                    renderScenarioTable('buy-scenario-table-container', 'BUY', active_levels_data, instrDetails.currency, inputs.pointDecimals);
                } else {
                    totalSellMarginPercent = margin_percent_of_balance;
                    maxCalculatedDrawdownSell = Math.abs(max_drawdown_for_this_side);
                    sellGridDataForChart.levels = active_levels_data;
                    renderScenarioTable('sell-scenario-table-container', 'SELL', active_levels_data, instrDetails.currency, inputs.pointDecimals);
                }


                results += `--- ${side} GRID (BATCH KAPAMA SENARYOSU) ---\n`;
                results += `Aktif Kademe Sayısı: ${active_levels_data.length}\n`;
                results += `Toplam Lot: ${total_lots.toFixed(2)}\n`;
                results += `Ortalama Giriş Fiyatı: ${final_avg_entry_price.toFixed(inputs.pointDecimals)}\n`;
                results += `Grup TP Fiyatı (Son aktif kademenin TP'sine göre): ${final_group_tp_price.toFixed(inputs.pointDecimals)}\n`;
                results += `Net Kar (Grup TP'de): ${final_potential_profit.toFixed(2)} ${instrDetails.currency}\n`;
                results += `Risk/Kazanç Oranı (Yaklaşık): 1 : ${(max_drawdown_for_this_side !== 0 ? Math.abs(final_potential_profit / max_drawdown_for_this_side) : Infinity).toFixed(2)}\n`;
                results += `Gereken Toplam Marjin: ${total_margin_needed.toFixed(2)} ${instrDetails.currency}\n`;
                results += `Bakiye Üzerinden Marjin %: ${margin_percent_of_balance.toFixed(2)}%\n`;
                results += `Max DD (Bir sonraki seviye açılana kadar): ${max_drawdown_for_this_side.toFixed(2)} ${instrDetails.currency} (${drawdown_percent_of_balance.toFixed(2)}%)\n`;
                if(inputs.riskPercent > 0 && drawdown_percent_of_balance > inputs.riskPercent) {
                    results += `UYARI: Hesaplanan DD (${drawdown_percent_of_balance.toFixed(2)}%), hedeflenen risk yüzdesini (${inputs.riskPercent.toFixed(1)}%) aşıyor!\n`;
                }
                results += "\nKademe Detayları (Grup TP'si Son Kademenin TP'sine Göre Hesaplanmıştır):\n";
                results += "Lvl | Lot  | Giriş Fiyatı      | Küm.NPL(P)| Grup TP Fiyatı    | Küm. P&L @ Grup TP | DD (Sonraki Seviye)\n";
                results += "----|------|-------------------|-----------|-------------------|--------------------|--------------------\n";
                active_levels_data.forEach(lvl => {
                    results += `${lvl.level.toString().padEnd(3)} | ${lvl.lot.toFixed(2).padEnd(4)} | ${lvl.entry.toFixed(inputs.pointDecimals).padEnd(17)} | ${lvl.npl_cumulative.toString().padEnd(9)} | ${lvl.groupTpPriceIfThisIsLast.toFixed(inputs.pointDecimals).padEnd(17)} | ${lvl.cumulativePnlAtGroupTp.toFixed(2).padEnd(18)} | ${lvl.potentialDrawdownBeforeNext.toFixed(2)}\n`;
                });
                results += "\n";
            }

            processSide('BUY');
            processSide('SELL');

            resultsText.value = results;
            const totalRiskFromDD = Math.max(maxCalculatedDrawdownBuy, maxCalculatedDrawdownSell);
            const totalRiskPercentFromDD = inputs.balance > 0 ? (totalRiskFromDD / inputs.balance * 100) : 0;
            updateRiskMeters(totalBuyMarginPercent, totalSellMarginPercent, totalRiskPercentFromDD);
            renderPnlChart(buyGridDataForChart, sellGridDataForChart);
            renderRiskBreakdownChart(maxCalculatedDrawdownBuy, maxCalculatedDrawdownSell, instrDetails.currency);


        } catch (error) {
            console.error("Hesaplama hatası:", error);
            resultsText.value = "Hesaplama sırasında bir hata oluştu: " + error.message;
            updateRiskMeters(0,0,0);
            renderPnlChart({levels:[], currency: ""}, {levels:[], currency: ""});
            renderRiskBreakdownChart(0,0, "");
            renderScenarioTable('buy-scenario-table-container', 'BUY', [], "", 0);
            renderScenarioTable('sell-scenario-table-container', 'SELL', [], "", 0);
        }
    }

    function generateSetFileContent() {
        const inputs = collectInputs(); 
        let content = "";

        for(const key in EA_DEFAULT_PARAMS) {
            let val = inputs.ea[key]; 
            if (typeof val === 'boolean') val = val.toString().toLowerCase();
            else if (typeof val === 'number' && key.toLowerCase().includes('pivot')) val = val.toFixed(1);
            else if (typeof val === 'number') val = val; 
            else val = String(val); 
            
            content += `${key}=${val}\n`;
        }
        content += "\n";

        const maxLevelsForEA = 14; 
        for (let i = 0; i < maxLevelsForEA; i++) {
            const level = (i < inputs.manualLevels.length) ? inputs.manualLevels[i] : 
                          { SendOrder: false, LotSize: 0.01, NewPositionAddLevel: 0, tp: 0, sl: 0 }; 

            content += `SendOrder${i + 1}=${level.SendOrder.toString().toLowerCase()}\n`;
            content += `LotSize${i + 1}=${level.LotSize.toFixed(2)}\n`;
            if (i > 0) { 
                content += `NewPositionAddLevel${i + 1}=${level.NewPositionAddLevel}\n`;
            }
            content += `tp${i + 1}=${level.tp}\n`;
            content += `sl${i + 1}=${level.sl}\n`;
        }
        return content;
    }

    function exportSetFile() {
        const inputs = collectInputs(); 
        const content = generateSetFileContent();
        const activeLevels = inputs.manualLevels.filter(l => l.SendOrder).length || inputs.gridLevelCount;
        const avgDistance = inputs.manualLevels.length > 1 && inputs.manualLevels.filter(l=>l.SendOrder && l.NewPositionAddLevel > 0).length > 0 ? 
                            inputs.manualLevels.filter(l=>l.SendOrder && l.NewPositionAddLevel > 0).reduce((sum, l, _, arr) => sum + l.NewPositionAddLevel / arr.length, 0) : 
                            inputs.defaultGridDistance;
        const multiplier = inputs.lotProgressionModel === 'martingale' ? '2x' : 
                           inputs.lotProgressionModel === 'custom_multiplier' ? `${inputs.lotCustomMultiplier.toFixed(1)}x` : 
                           inputs.lotProgressionModel === 'fibonacci_weighted' ? `Fib${inputs.fiboStrength.toFixed(2)}` :
                           inputs.lotProgressionModel === 'linear' ? 'Lin' : 'Custom';
        const avgTp = inputs.manualLevels.filter(l => l.SendOrder).length > 0 ? 
                      (inputs.manualLevels.filter(l => l.SendOrder).reduce((sum, l) => sum + l.tp, 0) / activeLevels) : 
                      EA_LEVEL_DEFAULTS_BASE.tp;
        
        const filename = `${activeLevels}kademe${Math.round(avgDistance/100)}x${multiplier}_tp${Math.round(avgTp/100)}_mt5supurge.set`;
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        
        if (navigator.msSaveBlob) { 
            navigator.msSaveBlob(blob, filename);
        } else {
            const link = document.createElement('a');
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                showToast("Tarayıcınız dosya indirmeyi doğrudan desteklemiyor. İçeriği kopyalayıp bir .set dosyasına yapıştırın.", "warning");
                resultsText.value = content; 
                switchTab('sonuclar-tab');
            }
        }
        showToast(".set dosyası oluşturuldu/indiriliyor: " + filename, "success");
    }

    function saveAppSettingsToLocalStorage() { // This will be triggered by the modal now
        try {
            const settings = collectInputs();
            localStorage.setItem('proGridCalculatorSettings_v5_api', JSON.stringify(settings)); 
            showToast('Geçici ayarlar başarıyla kaydedildi (Preset olarak kaydetmek için Presetler tabını veya Kaydet butonunu kullanın)!', "success");
        } catch (e) {
            showToast('Ayarlar kaydedilirken bir hata oluştu. (LocalStorage dolu olabilir)', "error");
            console.error("LocalStorage kaydetme hatası:", e);
        }
    }

    function loadAppSettingsFromLocalStorage() { // This will be triggered by the modal now
        try {
            const savedSettings = localStorage.getItem('proGridCalculatorSettings_v5_api');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                instrumentSelect.value = settings.instrumentName || "ALTIN (XAUUSD)";
                finnhubApiKeyInput.value = settings.finnhubApiKey || "";
                handleInstrumentChange(); 
                upperPriceRangeInput.value = settings.upperPriceRange || "";
                lowerPriceRangeInput.value = settings.lowerPriceRange || "";
                timeframeSelect.value = settings.timeframe || "H1";
                startPriceInput.value = settings.startPrice || INSTRUMENT_PRESETS[instrumentSelect.value].example_price;
                pointDecimalsInput.value = settings.pointDecimals || INSTRUMENT_PRESETS[instrumentSelect.value].point_decimal_places;
                tickSizeInput.value = settings.tickSize || INSTRUMENT_PRESETS[instrumentSelect.value].tick_size;
                valuePerPointInput.value = settings.valuePerPointPerLot || INSTRUMENT_PRESETS[instrumentSelect.value].value_per_point_per_lot;
                balanceInput.value = settings.balance || 2000;
                leverageInput.value = settings.leverage || 100;
                contractSizeInput.value = settings.contractSize || INSTRUMENT_PRESETS[instrumentSelect.value].contract_size;
                volatilityInput.value = settings.volatilityInput || INSTRUMENT_PRESETS[instrumentSelect.value].default_volatility; // Load saved volatility
                updateSliderDisplay(volatilityInput, volatilityValueDisplay);
                useAtrForSmartDistanceCheckbox.checked = settings.useAtrForSmartDistance !== undefined ? settings.useAtrForSmartDistance : true;
                riskPercentInput.value = settings.riskPercent || 5.0;

                gridLevelCountInput.value = settings.gridLevelCount || 14;
                updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
                lotProgressionModelSelect.value = settings.lotProgressionModel || "martingale";
                handleLotProgressionChange(); 
                lotCustomMultiplierInput.value = settings.lotCustomMultiplier || 1.5;
                updateSliderDisplay(lotCustomMultiplierInput, lotCustomMultiplierDisplay, 2);
                fiboStrengthLevelSelect.value = settings.fiboStrength || 0.618;
                initialLotInput.value = settings.initialLot || 0.01;
                totalLotTargetInput.value = settings.totalLotTarget || "";
                gridDistancePointsNumInput.value = settings.defaultGridDistance || 0; 
                gridDistancePointsInput.value = gridDistancePointsNumInput.value; 
                updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
                defaultTpPointsNumInput.value = settings.defaultTp || EA_LEVEL_DEFAULTS_BASE.tp;
                defaultTpPointsInput.value = defaultTpPointsNumInput.value;
                updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
                defaultSlPointsNumInput.value = settings.defaultSl || EA_LEVEL_DEFAULTS_BASE.sl;
                defaultSlPointsInput.value = defaultSlPointsNumInput.value;
                updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
                maxLotPerOrderInput.value = settings.maxLotPerOrder || "";


                createLevelInputs(); 

                if (settings.manualLevels && settings.manualLevels.length > 0) {
                     settings.manualLevels.forEach((savedLevel, i) => {
                        if (levelInputFields[i]) { 
                            levelInputFields[i].SendOrder.checked = savedLevel.SendOrder;
                            levelInputFields[i].LotSize.value = savedLevel.LotSize;
                            levelInputFields[i].NewPositionAddLevel.value = savedLevel.NewPositionAddLevel;
                            levelInputFields[i].tp.value = savedLevel.tp;
                            levelInputFields[i].sl.value = savedLevel.sl;
                        }
                    });
                } else {
                     applyLotProgressionAndPopulateManualGrid(); 
                }
                
                if(settings.ea) {
                    for(const key in eaParams) {
                         const eaKeyInSettings = Object.keys(settings.ea).find(k => k.toLowerCase() === key.toLowerCase());
                         if (eaKeyInSettings && settings.ea[eaKeyInSettings] !== undefined) {
                            if (eaParams[key].type === 'checkbox') {
                                eaParams[key].checked = settings.ea[eaKeyInSettings];
                            } else {
                                eaParams[key].value = settings.ea[eaKeyInSettings];
                            }
                        } else { 
                            if (eaParams[key].type === 'checkbox') {
                                 eaParams[key].checked = EA_DEFAULT_PARAMS[key] !== undefined ? EA_DEFAULT_PARAMS[key] : false;
                            } else {
                                 eaParams[key].value = EA_DEFAULT_PARAMS[key] !== undefined ? EA_DEFAULT_PARAMS[key] : '';
                            }
                        }
                    }
                } else {
                    loadEAParamDefaultsToUIOnly(); 
                }
                calculateAndDisplayGrid();
                showToast('Son kaydedilen çalışma ayarları yüklendi!', "success");
            } else {
                showToast('Kaydedilmiş çalışma ayarı bulunamadı. Varsayılanlar kullanılıyor.', "info");
                loadEADefaultsToUI(); // Load app defaults if no specific session save found
            }
        } catch (e) {
            showToast('Ayarlar yüklenirken bir hata oluştu.', "error");
            console.error("LocalStorage yükleme hatası:", e);
            loadEADefaultsToUI();
        }
    }
    
    function loadEAParamDefaultsToUIOnly() { 
         for(const key in EA_DEFAULT_PARAMS) {
            if (eaParams[key]) { 
                const defaultValue = EA_DEFAULT_PARAMS[key];
                if (eaParams[key].type === 'checkbox') {
                    eaParams[key].checked = defaultValue;
                } else {
                    eaParams[key].value = defaultValue;
                }
            }
        }
    }

    function loadEADefaultsToUI() {
        instrumentSelect.value = "ALTIN (XAUUSD)";
        finnhubApiKeyInput.value = localStorage.getItem('finnhubApiKey_v1') || ""; // Load saved API key
        handleInstrumentChange(); 

        upperPriceRangeInput.value = "";
        lowerPriceRangeInput.value = "";
        timeframeSelect.value = "H1";
        balanceInput.value = 2000;
        leverageInput.value = 100;
        useAtrForSmartDistanceCheckbox.checked = true;
        riskPercentInput.value = 5.0;
        
        gridLevelCountInput.value = 14;
        updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
        lotProgressionModelSelect.value = "martingale";
        handleLotProgressionChange();
        lotCustomMultiplierInput.value = 1.5;
        updateSliderDisplay(lotCustomMultiplierInput, lotCustomMultiplierDisplay, 2);
        fiboStrengthLevelSelect.value = 0.618;
        initialLotInput.value = 0.01;
        totalLotTargetInput.value = ""; 
        gridDistancePointsNumInput.value = 0; 
        gridDistancePointsInput.value = 0;
        updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
        defaultTpPointsNumInput.value = EA_LEVEL_DEFAULTS_BASE.tp; defaultTpPointsInput.value = EA_LEVEL_DEFAULTS_BASE.tp; updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
        defaultSlPointsNumInput.value = EA_LEVEL_DEFAULTS_BASE.sl; defaultSlPointsInput.value = EA_LEVEL_DEFAULTS_BASE.sl; updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
        maxLotPerOrderInput.value = ""; 
        calculateSmartDistance(); 
        
        createLevelInputs(); 
        applyLotProgressionAndPopulateManualGrid(); 

        loadEAParamDefaultsToUIOnly(); 
        
        calculateAndDisplayGrid();
        showToast('Varsayılan EA ve Seviye ayarları GUI\'ye yüklendi.', "info");
    }

    function showToast(message, type = 'info') { 
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'ℹ️';
        if (type === 'success') icon = '✅';
        else if (type === 'warning') icon = '⚠️';
        else if (type === 'error') icon = '❌';

        toast.innerHTML = `<span class="toast-icon">${icon}</span> <span class="toast-message">${message}</span> <button class="toast-close">&times;</button>`;
        toastContainer.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 100);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300); 
        }, 5000);

        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        });
    }

    function showLoader() { loaderOverlay.style.display = 'flex'; }
    function hideLoader() { loaderOverlay.style.display = 'none'; }

    // --- Modal Preset Management ---
    function openSavePresetModal() {
        const inputs = collectInputs();
        const activeLevels = inputs.manualLevels.filter(l => l.SendOrder).length || inputs.gridLevelCount;
        const avgDistance = inputs.defaultGridDistance;
        const multiplier = inputs.lotProgressionModel === 'martingale' ? '2x' : 
                           inputs.lotProgressionModel === 'custom_multiplier' ? `${inputs.lotCustomMultiplier.toFixed(1)}x` :
                           inputs.lotProgressionModel === 'fibonacci_weighted' ? `Fib${inputs.fiboStrength.toFixed(2)}` :
                           inputs.lotProgressionModel === 'linear' ? 'Lin' : 'Custom';
        const avgTp = inputs.manualLevels.length > 0 && activeLevels > 0 ? (inputs.manualLevels.filter(l=>l.SendOrder).reduce((s,l)=>s+l.tp,0) / activeLevels || EA_LEVEL_DEFAULTS_BASE.tp) : EA_LEVEL_DEFAULTS_BASE.tp;
        modalPresetNameInput.value = `${activeLevels}kademe_${multiplier}_${Math.round(avgDistance/100)}D_TP${Math.round(avgTp/100)}`;
        savePresetModal.style.display = "flex";
    }

    function confirmSavePresetFromModal() {
        saveCurrentSettingsAsPreset(modalPresetNameInput.value);
        savePresetModal.style.display = "none";
    }

    function openLoadPresetModal() {
        modalPresetList.innerHTML = ""; // Clear previous list
        const presets = JSON.parse(localStorage.getItem('proGridPresets_v1')) || [];
        if (presets.length === 0) {
            modalPresetList.innerHTML = "<p style='color:var(--text-muted-color); text-align:center;'>Kaydedilmiş preset bulunmuyor.</p>";
        } else {
            presets.forEach((preset, index) => {
                const item = document.createElement('div');
                item.className = 'modal-preset-item';
                item.innerHTML = `<span class="preset-name">${preset.name}</span>`;
                item.addEventListener('click', () => {
                    loadPresetFromSlot(index);
                    loadPresetModal.style.display = "none";
                });
                modalPresetList.appendChild(item);
            });
        }
        loadPresetModal.style.display = "flex";
    }


    const MAX_PRESETS = 20;
    function saveCurrentSettingsAsPreset(presetNameFromInput) { // Accepts name from tab or modal
        const inputs = collectInputs();
        let presetName = presetNameFromInput ? presetNameFromInput.trim() : newPresetNameInputTab.value.trim(); // Use tab's input if no name from modal
        
        if (!presetName) { // Auto-generate name if still empty
            const activeLevels = inputs.manualLevels.filter(l => l.SendOrder).length || inputs.gridLevelCount;
            const avgDistance = inputs.defaultGridDistance;
            const multiplier = inputs.lotProgressionModel === 'martingale' ? '2x' : 
                               inputs.lotProgressionModel === 'custom_multiplier' ? `${inputs.lotCustomMultiplier.toFixed(1)}x` :
                               inputs.lotProgressionModel === 'fibonacci_weighted' ? `Fib${inputs.fiboStrength.toFixed(2)}` :
                               inputs.lotProgressionModel === 'linear' ? 'Lin' : 'Custom';
            const avgTp = inputs.manualLevels.length > 0 && activeLevels > 0 ? (inputs.manualLevels.filter(l=>l.SendOrder).reduce((s,l)=>s+l.tp,0) / activeLevels || EA_LEVEL_DEFAULTS_BASE.tp) : EA_LEVEL_DEFAULTS_BASE.tp;
            presetName = `${activeLevels}kademe_${multiplier}_${Math.round(avgDistance/100)}D_TP${Math.round(avgTp/100)}`;
        }

        let presets = JSON.parse(localStorage.getItem('proGridPresets_v1')) || [];
        const existingPresetIndex = presets.findIndex(p => p.name === presetName);

        if (existingPresetIndex !== -1) {
            if (!confirm(`"${presetName}" adında bir preset zaten var. Üzerine yazılsın mı?`)) {
                return;
            }
            presets.splice(existingPresetIndex, 1); // Remove existing to re-add at top
        }
        
        presets.unshift({ name: presetName, settings: inputs, date: new Date().toISOString() }); 
        if (presets.length > MAX_PRESETS) presets.pop(); 
        
        localStorage.setItem('proGridPresets_v1', JSON.stringify(presets));
        newPresetNameInputTab.value = ""; 
        modalPresetNameInput.value = ""; // Clear modal input too
        loadPresetsFromStorage();
        showToast(`Preset "${presetName}" kaydedildi!`, "success");
    }

    function loadPresetsFromStorage() { // Populates both tab list and modal list (if modal is open)
        const presets = JSON.parse(localStorage.getItem('proGridPresets_v1')) || [];
        
        // Populate Tab List
        presetListContainerTab.innerHTML = "";
        if (presets.length === 0) {
            presetListContainerTab.innerHTML = "<p style='color:var(--text-muted-color); text-align:center;'>Kaydedilmiş preset bulunmuyor.</p>";
        } else {
            presets.forEach((preset, index) => {
                const slot = document.createElement('div');
                slot.className = 'preset-slot'; // This is for the tab view
                slot.innerHTML = `
                    <span class="preset-name" title="${preset.name}">${preset.name}</span>
                    <div class="preset-actions">
                        <button class="btn btn-secondary btn-sm preset-load-btn" data-index="${index}">Yükle</button>
                        <button class="btn btn-danger btn-sm preset-delete-btn" data-index="${index}" style="background-color:var(--danger-color); color:#fff;">Sil</button>
                    </div>
                `;
                presetListContainerTab.appendChild(slot);
            });
            document.querySelectorAll('#preset-management-tab .preset-load-btn').forEach(btn => {
                btn.addEventListener('click', (e) => loadPresetFromSlot(parseInt(e.target.dataset.index)));
            });
            document.querySelectorAll('#preset-management-tab .preset-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deletePresetSlot(parseInt(e.target.dataset.index)));
            });
        }
    }

    function loadPresetFromSlot(index) {
        const presets = JSON.parse(localStorage.getItem('proGridPresets_v1')) || [];
        if (presets[index]) {
            const settingsToLoad = presets[index].settings;
            
            instrumentSelect.value = settingsToLoad.instrumentName || "ALTIN (XAUUSD)";
            finnhubApiKeyInput.value = settingsToLoad.finnhubApiKey || "";
            handleInstrumentChange(); 
            upperPriceRangeInput.value = settingsToLoad.upperPriceRange || "";
            lowerPriceRangeInput.value = settingsToLoad.lowerPriceRange || "";
            timeframeSelect.value = settingsToLoad.timeframe || "H1";
            startPriceInput.value = settingsToLoad.startPrice;
            pointDecimalsInput.value = settingsToLoad.pointDecimals;
            tickSizeInput.value = settingsToLoad.tickSize;
            valuePerPointInput.value = settingsToLoad.valuePerPointPerLot;
            balanceInput.value = settingsToLoad.balance;
            leverageInput.value = settingsToLoad.leverage;
            contractSizeInput.value = settingsToLoad.contractSize;
            volatilityInput.value = settingsToLoad.volatilityInput; // Load saved slider value
            updateSliderDisplay(volatilityInput, volatilityValueDisplay);
            useAtrForSmartDistanceCheckbox.checked = settingsToLoad.useAtrForSmartDistance;
            riskPercentInput.value = settingsToLoad.riskPercent;

            gridLevelCountInput.value = settingsToLoad.gridLevelCount;
            updateSliderDisplay(gridLevelCountInput, gridLevelCountDisplay);
            lotProgressionModelSelect.value = settingsToLoad.lotProgressionModel;
            handleLotProgressionChange();
            lotCustomMultiplierInput.value = settingsToLoad.lotCustomMultiplier;
            updateSliderDisplay(lotCustomMultiplierInput, lotCustomMultiplierDisplay, 2);
            fiboStrengthLevelSelect.value = settingsToLoad.fiboStrength;
            initialLotInput.value = settingsToLoad.initialLot;
            totalLotTargetInput.value = settingsToLoad.totalLotTarget;
            gridDistancePointsNumInput.value = settingsToLoad.defaultGridDistance;
            gridDistancePointsInput.value = settingsToLoad.defaultGridDistance;
            updateSliderDisplay(gridDistancePointsInput, gridDistancePointsDisplay);
            defaultTpPointsNumInput.value = settingsToLoad.defaultTp; defaultTpPointsInput.value = settingsToLoad.defaultTp; updateSliderDisplay(defaultTpPointsInput, defaultTpPointsDisplay);
            defaultSlPointsNumInput.value = settingsToLoad.defaultSl; defaultSlPointsInput.value = settingsToLoad.defaultSl; updateSliderDisplay(defaultSlPointsInput, defaultSlPointsDisplay);
            maxLotPerOrderInput.value = settingsToLoad.maxLotPerOrder === Infinity ? "" : settingsToLoad.maxLotPerOrder;


            createLevelInputs(); 
            if (settingsToLoad.manualLevels) {
                 settingsToLoad.manualLevels.forEach((savedLevel, i) => {
                    if (levelInputFields[i]) { 
                        levelInputFields[i].SendOrder.checked = savedLevel.SendOrder;
                        levelInputFields[i].LotSize.value = savedLevel.LotSize;
                        levelInputFields[i].NewPositionAddLevel.value = savedLevel.NewPositionAddLevel;
                        levelInputFields[i].tp.value = savedLevel.tp;
                        levelInputFields[i].sl.value = savedLevel.sl;
                    }
                });
            }
             if(settingsToLoad.ea) {
                for(const key in eaParams) {
                    if (settingsToLoad.ea[key] !== undefined) {
                         if (eaParams[key].type === 'checkbox') eaParams[key].checked = settingsToLoad.ea[key];
                         else eaParams[key].value = settingsToLoad.ea[key];
                    }
                }
            }
            calculateAndDisplayGrid();
            showToast(`Preset "${presets[index].name}" yüklendi!`, "success");
            switchTab('temel-ayarlar-tab'); 
        }
    }

    function deletePresetSlot(index) {
        if (!confirm("Bu preseti silmek istediğinizden emin misiniz?")) return;
        let presets = JSON.parse(localStorage.getItem('proGridPresets_v1')) || [];
        const deletedPresetName = presets[index] ? presets[index].name : "Bilinmeyen";
        presets.splice(index, 1);
        localStorage.setItem('proGridPresets_v1', JSON.stringify(presets));
        loadPresetsFromStorage();
        showToast(`Preset "${deletedPresetName}" silindi.`, "info");
    }
    
    async function autoSetFiboPriceRange(applyToInputs = true) {
        const apiKey = finnhubApiKeyInput.value.trim();
        if (!apiKey) {
            fiboLevelsDisplay.innerHTML = "Lütfen Finnhub API anahtarınızı girin.";
            showToast("Fibo seviyeleri için Finnhub API anahtarı gerekli.", "warning");
            return;
        }
        localStorage.setItem('finnhubApiKey_v1', apiKey); // Save API key

        const currentPrice = parseFloat(startPriceInput.value);
        const pointDec = parseInt(pointDecimalsInput.value);
        const selectedInstrumentName = instrumentSelect.value;
        const finnhubSymbol = INSTRUMENT_PRESETS[selectedInstrumentName]?.finnhub_symbol;
        const selectedTimeframe = timeframeSelect.value;

        if (isNaN(currentPrice) || !finnhubSymbol || isNaN(pointDec)) {
            fiboLevelsDisplay.innerHTML = "Fibo aralığı için geçerli fiyat, enstrüman ve ondalık girin.";
            return;
        }

        showLoader();
        fiboLevelsDisplay.innerHTML = "Fibo seviyeleri Finnhub API'den alınıyor...";

        const resolutionMap = { "M1":"1", "M5":"5", "M15":"15", "M30":"30", "H1":"60", "H4":"240", "D1":"D", "W1":"W", "MN1":"M" };
        const resolution = resolutionMap[selectedTimeframe] || "D";
        const toTimestamp = Math.floor(Date.now() / 1000);
        let fromTimestamp;
        // Adjust 'from' based on resolution to get enough data for swing points
        if (resolution === "D" || resolution === "W" || resolution === "M") {
            fromTimestamp = toTimestamp - (365 * 24 * 60 * 60); // Approx 1 year for daily/weekly/monthly
        } else {
            fromTimestamp = toTimestamp - (90 * 24 * 60 * 60); // Approx 3 months for intraday
        }

        const url = `https://finnhub.io/api/v1/stock/candle?symbol=${finnhubSymbol}&resolution=${resolution}&from=${fromTimestamp}&to=${toTimestamp}&token=${apiKey}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API isteği başarısız: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();

            if (data.s !== "ok" || !data.h || data.h.length === 0) {
                throw new Error("API'den geçerli fiyat verisi alınamadı. Sembol veya zaman aralığını kontrol edin.");
            }

            // Find swing high and low from the last N candles (e.g., 100)
            const lookbackPeriod = Math.min(100, data.h.length);
            const recentHighs = data.h.slice(-lookbackPeriod);
            const recentLows = data.l.slice(-lookbackPeriod);
            
            const swingHigh = Math.max(...recentHighs);
            const swingLow = Math.min(...recentLows);
            const range = swingHigh - swingLow;

            if (range <= 0) {
                throw new Error("Hesaplanan fiyat aralığı geçersiz (High <= Low). API verisini kontrol edin.");
            }

            const fibRatios = [0, 0.236, 0.382, 0.500, 0.618, 0.786, 1.0];
            let fiboText = `<strong>Finnhub Fibo Seviyeleri (${selectedTimeframe} - ${finnhubSymbol}):</strong><br>`;
            fiboText += `Swing Low: ${swingLow.toFixed(pointDec)}, Swing High: ${swingHigh.toFixed(pointDec)}<br>`;
            fiboText += "<u>Retracements:</u><br>";
            fibRatios.forEach(ratio => {
                const levelPriceUpTrend = swingLow + (range * ratio);
                const levelPriceDownTrend = swingHigh - (range * ratio);
                fiboText += `${(ratio*100).toFixed(1)}%: ${levelPriceDownTrend.toFixed(pointDec)} (Düşüş) / ${levelPriceUpTrend.toFixed(pointDec)} (Yükseliş)<br>`;
            });
            fiboLevelsDisplay.innerHTML = fiboText;

            if (applyToInputs) {
                upperPriceRangeInput.value = swingHigh.toFixed(pointDec);
                lowerPriceRangeInput.value = swingLow.toFixed(pointDec);
                showToast("Fiyat aralığı Finnhub Fibo S/R'ye göre ayarlandı ve uygulandı.", "success");
                applyLotProgressionAndPopulateManualGrid();
                calculateAndDisplayGrid();
            } else {
                 showToast("Finnhub Fibo S/R seviyeleri başarıyla çekildi.", "info");
            }

        } catch (error) {
            console.error("Finnhub API Hatası:", error);
            fiboLevelsDisplay.innerHTML = `Fibo seviyeleri alınamadı: ${error.message}`;
            showToast(`Fibo API Hatası: ${error.message}`, "error");
        } finally {
            hideLoader();
        }
    }


    </script>
    <!-- <script src="sw-loader.js" defer></script> --> 
</body>
</html>
